<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Estoque com An√°lise Preditiva - Borracha</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .has-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            cursor: help;
        }

        .has-tooltip::before,
        .has-tooltip::after {
            content: none !important;
        }

        .tooltip-bubble {
            position: absolute;
            z-index: 99999;
            background: rgba(31, 68, 140, 0.98);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 10px 24px rgba(16, 39, 89, 0.25);
            font-size: 12px;
            line-height: 1.5;
            max-width: min(320px, calc(100vw - 32px));
            pointer-events: none;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            will-change: transform, opacity;
        }

        .tooltip-bubble::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: inherit;
            border-radius: 2px;
            left: var(--tooltip-arrow-left, 50%);
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .tooltip-bubble[data-position="bottom"]::after {
            top: 0;
        }

        .tooltip-bubble[data-position="top"]::after {
            bottom: 0;
        }

        .tooltip-bubble.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: auto;
            height: auto;
            padding: 0 3px;
            border-radius: 4px;
            background-color: transparent;
            border: 1px solid transparent;
            color: #2f4a87;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
            margin-left: 4px;
            box-shadow: none;
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .info-icon:hover,
        .info-icon:focus-visible {
            color: #1F448C;
            background-color: rgba(31, 68, 140, 0.12);
            border-color: rgba(31, 68, 140, 0.2);
        }

        .info-icon:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(31, 68, 140, 0.18);
        }

        .tooltip-underline {
            border-bottom: 1px dashed rgba(31, 68, 140, 0.45);
        }

        .prediction-tooltip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            max-width: 100%;
            line-height: 1.4;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            text-align: left;
        }

        .header-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        th .header-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .stat-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
            text-align: center;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            margin: 0;
            flex: 1;
            min-width: 300px;
        }
        
        .company-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 300px;
            height: 60px;
        }
        
        .company-logo img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .search-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 20px;
            border: 2px solid #1F448C;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(31, 68, 140, 0.1);
            transform: translateY(-1px);
        }
        
        .search-results {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #1F448C;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        button:hover {
            background-color: #163666;
            transform: translateY(-1px);
        }
        
        button.active {
            background-color: #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        button.btn-auto-save {
            background-color: #28a745;
            position: relative;
        }

        button.btn-auto-save:hover {
            background-color: #218838;
        }

        button.btn-auto-save.ready {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .btn-download-highlight {
            background-color: #28a745 !important;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
            transform: scale(1.05);
        }
        
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            min-width: 180px;
        }
        
        select:focus {
            border-color: #1F448C;
            outline: none;
        }
        
        .import-section {
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }
        
        .import-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        
        .import-header:hover {
            background-color: #d1e7fd;
        }
        
        .import-content {
            padding: 0 15px 15px 15px;
            display: none;
            transition: all 0.3s ease;
        }
        
        .import-content.expanded {
            display: block !important;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 18px;
        }
        
        .toggle-icon.expanded {
            transform: rotate(180deg);
        }
        
        .file-input {
            margin: 10px 0;
        }
        
        input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .gauges-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .gauge-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .gauge-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border-color: #1F448C;
        }
        
        .gauge-card.selected {
            border: 2px solid #1F448C;
            background-color: #f8f9ff;
            box-shadow: 0 4px 16px rgba(31, 68, 140, 0.3);
        }
        
        .gauge-card.highlighted {
            border: 2px solid #1F448C;
            box-shadow: 0 4px 16px rgba(31, 68, 140, 0.3);
        }
        
        .gauge {
            position: relative;
            width: 240px;
            height: 140px;
            margin: 0 auto;
        }
        
        .gauge-title {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .gauge-value {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .gauge-label {
            position: absolute;
            top: 85%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
        }
        
        .products-table {
            margin-top: 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }

        #tableCount {
            font-size: 13px;
            color: #4c5569;
        }

        .table-container {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            padding: 8px;
        }

        .table-scroll {
            max-height: 600px;
            overflow: auto;
            border-radius: inherit;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .table-scroll table {
            min-width: 1100px;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #ddd;
            z-index: 5;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            line-height: 1.4;
            word-break: break-word;
        }

        .item-name {
            font-weight: 600;
            color: #1f2a44;
        }

        .item-coverage {
            margin-top: 4px;
            font-size: 12px;
            color: #4d5f94;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .item-coverage strong {
            color: #1F448C;
        }

        .coverage-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .coverage-tag.from-import {
            background: #e3f2fd;
            color: #1F448C;
        }

        .coverage-tag.from-estimate {
            background: #fff3cd;
            color: #856404;
        }

        .coverage-tag.no-data {
            background: #eceff1;
            color: #546e7a;
        }

        .status-cell {
            white-space: nowrap;
        }

        .prediction-cell {
            max-width: 220px;
            white-space: normal;
        }

        .prediction-cell .prediction-tooltip {
            width: 100%;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        tr.highlighted {
            background-color: #e3f2fd !important;
            border-left: 4px solid #1F448C;
        }
        
        .status-critical {
            background-color: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }
        
        .status-warning {
            background-color: #fff8e1 !important;
            color: #f57c00;
        }
        
        .status-good {
            background-color: #e8f5e8 !important;
            color: #2e7d32;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 20px;
        }

        .pareto-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .pareto-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .pareto-description {
            margin: -5px 0 15px;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .pareto-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pareto-table th,
        .pareto-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .pareto-table th {
            background: #e3f2fd;
            color: #1F448C;
        }

        .pareto-empty {
            margin: 12px 0 0;
            color: #666;
            text-align: center;
            font-size: 14px;
        }

        .abc-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            color: #fff;
        }

        .abc-chip.abc-a {
            background-color: #f44336;
        }

        .abc-chip.abc-b {
            background-color: #ff9800;
        }

        .abc-chip.abc-c {
            background-color: #4caf50;
        }

        tr.abc-row-a {
            box-shadow: inset 4px 0 0 #f44336;
        }

        tr.abc-row-b {
            box-shadow: inset 4px 0 0 #ff9800;
        }

        tr.abc-row-c {
            box-shadow: inset 4px 0 0 #4caf50;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .stat-item.clickable {
            cursor: pointer;
        }
        
        .stat-item.clickable:hover {
            background-color: #ffebee;
            border-color: #f44336;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1F448C;
        }
        
        .stat-value.critical {
            color: #f44336;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        #historyModal .modal-content {
            margin: 40px auto;
            max-width: 960px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border-radius: 24px;
            overflow: hidden;
            padding: 0;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-modal-header {
            margin: 0;
            padding: 24px 32px 12px;
            border-bottom: 1px solid #e4e9f7;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .history-modal-body {
            padding: 8px 32px 32px;
            background: linear-gradient(180deg, #ffffff 0%, #ffffff 100%);
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .history-modal-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
            --history-header-gradient: linear-gradient(135deg, #1d396e 0%, #2d4174 55%, #113b96 100%);
            --history-header-text: #ffffff;
            --history-header-subtext: rgba(255, 255, 255, 0.85);
            --history-family-chip-bg: rgba(255, 255, 255, 0.16);
            --history-family-chip-text: #ffffff;
        }

        .history-header {
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding: 28px;
            border-radius: 20px;
            background: var(--history-header-gradient);
            box-shadow: 0 18px 42px rgba(31, 68, 140, 0.25);
            color: var(--history-header-text);
        }

        .history-title {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-header h1 {
            margin: 0;
            font-size: 28px;
            color: var(--history-header-text);
            letter-spacing: 0.2px;
        }

        .history-header p {
            margin: 0;
            color: var(--history-header-subtext);
            font-size: 15px;
        }

        .history-code {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .history-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.16);
            color: var(--history-header-text);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .history-chip.family-chip {
            background: var(--history-family-chip-bg);
            color: var(--history-family-chip-text);
        }

        .history-overview {
            background: #ffffff;
            border: 1px solid #dce3f5;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(31, 68, 140, 0.12);
        }

        .history-overview.history-coverage {
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .history-coverage-info {
            background: #ffffff;
            border: 1px solid #d4dcf3;
            border-radius: 16px;
            padding: 22px 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: 0 14px 28px rgba(31, 68, 140, 0.08);
        }

        .history-coverage-main {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-end;
            gap: 20px;
        }

        .history-coverage-heading {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-coverage-title {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #5d6fa3;
            font-weight: 700;
        }

        .history-coverage-value {
            font-size: 36px;
            font-weight: 700;
            color: #1f2a44;
            line-height: 1;
        }

        .history-coverage-value-group {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .history-coverage-unit {
            font-size: 16px;
            font-weight: 600;
            color: #5d6fa3;
            text-transform: lowercase;
        }

        .history-coverage-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0.2px;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .history-coverage-status.status-neutral {
            background-color: #eceff1;
            color: #546e7a;
        }

        .history-coverage-meta {
            font-size: 13px;
            color: #6b7ba6;
            line-height: 1.6;
            margin: 0;
        }

        .history-summary .history-coverage-meta {
            margin-top: 12px;
        }

        .history-section-title {
            margin: 0 0 12px 0;
            font-size: 18px;
            color: #1f2a44;
        }

        .history-metric-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .history-metric-list li {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            padding: 8px 0;
            border-bottom: 1px solid #eef2fb;
            font-size: 14px;
        }

        .history-metric-list li:last-child {
            border-bottom: none;
        }

        .history-metric-coverage {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #d4dcf3;
        }

        .history-metric-coverage .history-metric-value {
            font-weight: 700;
            color: #1f2a44;
        }

        .history-metric-label {
            font-weight: 600;
            color: #2f3e6d;
        }

        .history-metric-value {
            font-weight: 600;
            color: #1f448c;
            white-space: nowrap;
        }

        .history-month-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border: 1px solid #dce3f5;
            border-radius: 12px;
            overflow: hidden;
        }

        .history-month-table th,
        .history-month-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e6ecfb;
            text-align: left;
            font-size: 14px;
        }

        .history-month-table th {
            background: #f0f4ff;
            color: #1f2a44;
        }

        .history-month-table tr:last-child td {
            border-bottom: none;
        }

        .history-entry {
            background: #ffffff;
            border: 1px solid #dce3f5;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 18px 40px rgba(31, 68, 140, 0.062);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .history-entry:last-child {
            margin-bottom: 0;
        }

        .history-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 22px 48px rgba(31, 68, 140, 0.18);
        }

        .history-entry h4 {
            margin: 0 0 12px 0;
            color: #1f448c;
        }

        .history-subtitle {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.75);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .history-summary,
        .history-months {
            min-width: 0;
        }

        .history-summary h5,
        .history-months h5 {
            margin: 0 0 12px 0;
            font-size: 15px;
            color: #2f3e6d;
        }

        .history-empty {
            margin: 16px 0;
            color: #4d5f94;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }

        .modal-buttons button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .code-value {
            color: #1f2a44;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .link-button {
            background: none;
            border: none;
            color: #1F448C;
            cursor: pointer;
            padding: 0;
            font: inherit;
            text-decoration: underline;
            transition: none;
        }

        .link-button:hover,
        .link-button:focus-visible {
            color: #1F448C;
            text-decoration: underline;
            background-color: transparent;
            transform: none;
            box-shadow: none;
        }

        .link-button:focus-visible {
            outline: 2px solid rgba(31, 68, 140, 0.35);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }

        .offline-notice {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .browser-mode-indicator {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 14px;
        }

        .download-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .mapping-debug {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        @keyframes gaugeAnimation {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .gauge-card.animating {
            animation: gaugeAnimation 0.6s ease-out;
        }

        @keyframes highlight {
            0% { background-color: transparent; }
            50% { background-color: rgba(31, 68, 140, 0.1); }
            100% { background-color: transparent; }
        }

        .highlight-animation {
            animation: highlight 1s ease-in-out;
        }

        /* Responsividade para mobile */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .header h1 {
                min-width: auto;
                margin-bottom: 10px;
            }
            
            .company-logo {
                justify-content: center;
                font-size: 20px;
            }
            
            .search-input {
                min-width: 200px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .control-group label {
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 20px;
            }

            .history-modal-header {
                padding: 20px 20px 10px;
            }

            .history-modal-body {
                padding: 0 20px 24px;
            }

            .history-header {
                padding: 24px;
            }

            .history-meta {
                gap: 8px;
            }

            .gauges-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .gauge {
                width: 200px;
                height: 120px;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            th, td {
                padding: 6px 4px;
            }
        }

        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .gauge {
                width: 180px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard de Estoque - Borracha</h1>
            <div class="company-logo">
                <img src="https://usiquimica.com.br/wp-content/uploads/2022/05/usiquimica-logo-horizontal-1.png" alt="USIQUIMICA" />
            </div>
        </div>
        
        <div class="import-section">
            <div class="import-header" onclick="toggleImportSection()">
                <h3>üìä Importar Dados da Planilha</h3>
                <span class="toggle-icon" id="toggleIcon">‚ñº</span>
            </div>
            <div class="import-content" id="importContent">
                <div class="offline-notice">
                    <strong>üåê Modo Offline</strong> - Este dashboard funciona sem servidor! 
                    Importe suas planilhas e compartilhe os arquivos atualizados com sua equipe.
                    <div class="browser-mode-indicator" id="browserModeIndicator">
                        üîç Detectando modo do navegador...
                    </div>
                </div>
                
                <div class="file-input">
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" />
                    <button onclick="importData()">Importar Planilha</button>
                    <button onclick="tryAutoSave()" id="autoSaveBtn" class="btn-auto-save" style="display: none;">Configurar Pasta</button>
                    <button onclick="reconfigureAutoSave()" id="reconfigBtn" style="display: none; background-color: #6c757d;">üîß Reconfigurar</button>
                    <button onclick="openTemplateGenerator()" style="background-color: #28a745;">üìã Template</button>
                </div>
                <div id="importMessages"></div>
                <div id="mappingDebug" class="mapping-debug" style="display: none;"></div>
                <div id="lastUpdateInfo" style="font-size: 12px; color: #666; margin: 10px 0;"></div>
                <div id="debugInfo" class="debug-info" style="display: none;"></div>
                <small><strong>v1.3 - Importador Inteligente:</strong> Agora identifica automaticamente NOVEMBRO, DEZEMBRO e COBERTURA, al√©m de permitir escolher qual aba importar em planilhas com m√∫ltiplos meses.</small>
                
                <div class="download-section">
                    <h4>üìã Compartilhar Dados</h4>
                    <p>Ap√≥s importar, baixe o arquivo de dados atualizado e compartilhe com sua equipe:</p>
                    <button onclick="downloadDataFile()" style="background-color: #28a745; font-size: 16px; padding: 10px 20px;">üíæ Baixar data.js Atualizado</button>
                    <button onclick="testAutoSave()" id="testBtn" style="display: none; background-color: #17a2b8; margin-left: 10px;">üß™ Testar</button>
                    <button onclick="runDiagnostic()" style="background-color: #6c757d; margin-left: 10px;">üîç Diagn√≥stico</button>
                    <button onclick="toggleDebug()" style="background-color: #ffc107; margin-left: 10px;">üêõ Debug</button>
                    <button onclick="toggleMappingDebug()" style="background-color: #17a2b8; margin-left: 10px;">üìã Mapeamento</button>
                    <br><br>
                    <div style="background: #e8f4fd; padding: 12px; border-radius: 6px; border-left: 4px solid #0066cc;">
                        <strong>üîç Como compartilhar seus dados:</strong><br>
                        1. Clique em "üíæ Baixar data.js Atualizado" ap√≥s importar<br>
                        2. Substitua o arquivo <code>data.js</code> na pasta compartilhada<br>
                        3. Todos que acessarem o dashboard ver√£o os dados atualizados
                    </div>
                </div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input 
                    type="text" 
                    id="globalSearch" 
                    class="search-input" 
                    placeholder="üîç Buscar por c√≥digo ou nome do produto..."
                />
                <button class="clear-search" onclick="clearSearch()">üóëÔ∏è Limpar</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Filtrar por:</label>
                <button onclick="showAllProducts()" class="filter-btn active" data-filter="all">Todos</button>
                <button onclick="filterCriticalStock()" class="filter-btn" data-filter="critical">Estoque Cr√≠tico (&lt;2m)</button>
                <button onclick="filterLowStock()" class="filter-btn" data-filter="low">Estoque Baixo (2-6m)</button>
                <button onclick="filterHighStock()" class="filter-btn" data-filter="high">Slow Moving (&gt;6m)</button>
            </div>
            
            <div class="control-group">
                <label>Fam√≠lia:</label>
                <select id="familyFilter" onchange="filterByFamily()">
                    <option value="">Todas as Fam√≠lias</option>
                </select>
            </div>

            <div class="control-group">
                <label>Fornecedor:</label>
                <select id="supplierFilter" onchange="filterBySupplier()">
                    <option value="">Todos os Fornecedores</option>
                </select>
            </div>

            <div class="control-group">
                <label>Estabelecimento:</label>
                <select id="establishmentFilter" onchange="filterByEstablishment()">
                    <option value="">Todos os Estabelecimentos</option>
                    <option value="1-4">1-4 (GUARULHOS)</option>
                    <option value="90-13">90-13 (ITAJA√ç)</option>
                    <option value="90-15">90-15 (GARUVA)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Filtro avan√ßado:</label>
                <select id="advancedStockFilter" onchange="filterByAdvancedStock()">
                    <option value="">Todos os produtos</option>
                    <option value="no-stock">Sem estoque</option>
                    <option value="over50">Estoque &gt; 50 meses</option>
                    <option value="abc-a">Classe A</option>
                    <option value="abc-b">Classe B</option>
                    <option value="abc-c">Classe C</option>
                </select>
            </div>

            <div class="control-group">
                <button onclick="showExportModal()">üì§ Exportar</button>
                <button onclick="updateData()">üîÑ Atualizar</button>
            </div>
        </div>

        <div class="summary-card">
            <h3 class="header-label">Resumo Geral <span class="info-icon has-tooltip" tabindex="0" aria-label="Resumo Geral" data-tooltip="Indicadores principais do estoque considerando os filtros atuais, ajudando a entender a distribui√ß√£o e risco de ruptura." data-tooltip-position="top">?</span></h3>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label"><span class="label-text">Total de Produtos</span><span class="info-icon has-tooltip" tabindex="0" aria-label="Total de produtos" data-tooltip="Quantidade total de SKUs √∫nicos vis√≠veis ap√≥s aplicar filtros de busca e estabelecimento." data-tooltip-position="top">?</span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgStockMonths">0.0</div>
                    <div class="stat-label"><span class="label-text">M√©dia de Estoque (meses)</span><span class="info-icon has-tooltip" tabindex="0" aria-label="M√©dia de estoque" data-tooltip="Tempo m√©dio de cobertura em meses considerando todo o estoque dispon√≠vel dividido pelo consumo m√©dio dos √∫ltimos meses." data-tooltip-position="top">?</span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCoverage">--</div>
                    <div class="stat-label"><span class="label-text">Cobertura Total</span><span class="info-icon has-tooltip" tabindex="0" aria-label="Cobertura total" data-tooltip="Soma da cobertura (em meses) informada na planilha para os itens filtrados." data-tooltip-position="top">?</span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalStockValue">0</div>
                    <div class="stat-label"><span class="label-text">Estoque Total</span><span class="info-icon has-tooltip" tabindex="0" aria-label="Estoque total" data-tooltip="Soma das unidades dispon√≠veis considerando todos os filtros e estabelecimentos selecionados." data-tooltip-position="top">?</span></div>
                </div>
                <div class="stat-item clickable" onclick="filterCriticalStock()" title="Clique para ver produtos cr√≠ticos (<2 meses)">
                    <div class="stat-value critical" id="criticalCount">0</div>
                    <div class="stat-label"><span class="label-text">Produtos Cr√≠ticos</span><span class="info-icon has-tooltip" tabindex="0" aria-label="Produtos cr√≠ticos" data-tooltip="Itens com cobertura inferior a 2 meses. Clique no card para filtrar somente esses produtos." data-tooltip-position="top" onclick="event.stopPropagation();">?</span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFamilies">0</div>
                    <div class="stat-label"><span class="label-text">Fam√≠lias de Produtos</span><span class="info-icon has-tooltip" tabindex="0" aria-label="Fam√≠lias de produtos" data-tooltip="N√∫mero de fam√≠lias distintas representadas na lista atual de produtos." data-tooltip-position="top">?</span></div>
                </div>
            </div>
        </div>

        <div class="pareto-section">
            <h3 class="header-label">üìä An√°lise ABC por Vendas <span class="info-icon has-tooltip" tabindex="0" aria-label="An√°lise ABC por Vendas" data-tooltip="Organizamos os produtos conforme a fatia que cada um representa das vendas dos √∫ltimos meses. Itens com 5% ou mais das vendas ficam na Classe A, entre 1% e 5% na Classe B e os demais na Classe C." data-tooltip-position="top">?</span></h3>
            <p class="pareto-description">Calculamos quanto cada item representa sozinho do total vendido nos √∫ltimos 3 meses entre todos os produtos com sa√≠da. Itens com % Individual igual ou acima de 5% entram na Classe A, entre 1% e 5% ficam na Classe B e abaixo de 1% comp√µem a Classe C. A regra √© recalculada automaticamente conforme voc√™ aplica filtros, como fam√≠lia ou fornecedor.</p>
            <div id="paretoContent"></div>
        </div>
        <div class="gauges-container" id="gaugesContainer">
        </div>
        
        <div class="products-table">
            <div class="table-header">
                <h3 class="header-label">Detalhes dos Produtos <span class="info-icon has-tooltip" tabindex="0" aria-label="Detalhes dos Produtos" data-tooltip="Tabela com indicadores de estoque, consumo e classifica√ß√£o ABC de cada item ap√≥s aplicar os filtros ativos." data-tooltip-position="top">?</span></h3>
                <span id="tableCount">0 produtos exibidos</span>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table id="productsTable">
                    <thead>
                        <tr>
                            <th><span class="header-label">C√≥digo<span class="info-icon has-tooltip" tabindex="0" aria-label="C√≥digo" data-tooltip="Identificador √∫nico do item conforme cadastro interno.">?</span></span></th>
                            <th><span class="header-label">Fornecedor<span class="info-icon has-tooltip" tabindex="0" aria-label="Fornecedor" data-tooltip="Parceiro respons√°vel pelo fornecimento do item.">?</span></span></th>
                            <th><span class="header-label">Fam√≠lia<span class="info-icon has-tooltip" tabindex="0" aria-label="Fam√≠lia" data-tooltip="Categoria ou linha de produto utilizada para agrupar itens similares.">?</span></span></th>
                            <th><span class="header-label">Item<span class="info-icon has-tooltip" tabindex="0" aria-label="Item" data-tooltip="Descri√ß√£o comercial do produto.">?</span></span></th>
                            <th><span class="header-label">Est. 1-4<span class="info-icon has-tooltip" tabindex="0" aria-label="Estoque 1-4" data-tooltip="Saldo f√≠sico dispon√≠vel no estabelecimento 1-4 (Guarulhos).">?</span></span></th>
                            <th><span class="header-label">Est. 90-13<span class="info-icon has-tooltip" tabindex="0" aria-label="Estoque 90-13" data-tooltip="Saldo f√≠sico dispon√≠vel no estabelecimento 90-13 (Itaja√≠).">?</span></span></th>
                            <th><span class="header-label">Est. 90-15<span class="info-icon has-tooltip" tabindex="0" aria-label="Estoque 90-15" data-tooltip="Saldo f√≠sico dispon√≠vel no estabelecimento 90-15 (Garuva).">?</span></span></th>
                            <th><span class="header-label">Total<span class="info-icon has-tooltip" tabindex="0" aria-label="Total em estoque" data-tooltip="Soma do estoque dispon√≠vel em todos os estabelecimentos selecionados.">?</span></span></th>
                            <th><span class="header-label">Vendas 4M<span class="info-icon has-tooltip" tabindex="0" aria-label="Vendas 4 meses" data-tooltip="Quantidade vendida acumulada nos √∫ltimos 4 meses para o item, conforme informado na planilha." data-tooltip-position="top">?</span></span></th>
                            <th><span class="header-label">M√©dia 3M<span class="info-icon has-tooltip" tabindex="0" aria-label="M√©dia 3 meses" data-tooltip="M√©dia mensal das vendas dos √∫ltimos 3 meses, usada para estimar o consumo.">?</span></span></th>
                            <th><span class="header-label">Previs√£o<span class="info-icon has-tooltip" tabindex="0" aria-label="Previs√£o de ruptura" data-tooltip="Resumo da previs√£o de ruptura calculada para o item.">?</span></span></th>
                            <th><span class="header-label">Status<span class="info-icon has-tooltip" tabindex="0" aria-label="Status" data-tooltip="Classifica√ß√£o do risco atual com base nos meses de cobertura.">?</span></span></th>
                            <th><span class="header-label">Classe ABC<span class="info-icon has-tooltip" tabindex="0" aria-label="Classe ABC" data-tooltip="Classifica√ß√£o calculada pelo % Individual das vendas filtradas: itens com 5% ou mais das vendas ficam na Classe A, entre 1% e 5% na Classe B e os demais na Classe C.">?</span></span></th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Exporta√ß√£o -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Exportar Dados</h2>
                <span class="close" onclick="closeExportModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="fileName">Nome do arquivo:</label>
                <input type="text" id="fileName" value="estoque_dados" placeholder="Digite o nome do arquivo">
            </div>
            <div class="form-group">
                <label for="fileFormat">Formato:</label>
                <select id="fileFormat">
                    <option value="xlsx">Excel (.xlsx)</option>
                    <option value="csv">CSV (.csv)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeExportModal()">Cancelar</button>
                <button onclick="confirmExport()">Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Hist√≥rico do Produto -->
    <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-content history-modal-container">
            <div class="modal-header history-modal-header">
                <h2 id="historyModalTitle">Hist√≥rico do Produto</h2>
                <span class="close" role="button" tabindex="0" aria-label="Fechar hist√≥rico" onclick="closeHistoryModal()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();closeHistoryModal();}">&times;</span>
            </div>
            <div class="history-modal-body" id="historyModalContent"></div>
        </div>
    </div>

    <!-- Inclus√£o das bibliotecas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        // Vari√°veis globais
        let allProductsData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let currentEstablishment = '';
        let searchTerm = '';
        let predictionFilter = null;
        let selectedFamily = null;
        let selectedSupplier = null;
        let fileSystemSupported = false;
        let directoryHandle = null;
        let criticalFilterActive = false;
        let debugMode = false;
        let mappingDebugMode = false;
        let lastMappingInfo = null;
        let advancedStockFilter = '';
        let activeImportDescriptor = 'dados carregados';
        let lastImportedFileName = '';
        let lastImportedSheetName = '';

        const defaultFamilyAccentPalette = Object.freeze([
            '#FF6F61',
            '#2EC5B6',
            '#F2994A',
            '#9B51E0',
            '#56CCF2',
            '#27AE60',
            '#F2C94C',
            '#BB6BD9',
            '#EB5757',
            '#2D9CDB'
        ]);
        const defaultFamilyAccentOverrides = Object.freeze([
            ['borracha silicone', '#FF6F61'],
            ['borracha de silicone', '#FF6F61']
        ]);
        const familyAccentAssignments = new Map();
        const familyAccentConfiguration = initializeFamilyAccentConfig();
        const familyAccentPalette = familyAccentConfiguration.palette;
        const familyAccentOverrides = familyAccentConfiguration.overrides;
        const familyAccentFallback = familyAccentConfiguration.fallback;
        // Faixas do % individual das vendas usadas para classificar os itens
        const abcIndividualThresholds = Object.freeze({
            classA: 0.05,
            classB: 0.01
        });
        let abcClassificationMap = new Map();
        let tooltipElement = null;
        let activeTooltipTarget = null;
        let tooltipHideTimeout = null;

        const monthDetectionPatterns = Object.freeze([
            { order: 0, keywords: ['JANEIRO', 'JAN'] },
            { order: 1, keywords: ['FEVEREIRO', 'FEV'] },
            { order: 2, keywords: ['MARCO', 'MAR√áO', 'MAR'] },
            { order: 3, keywords: ['ABRIL', 'ABR'] },
            { order: 4, keywords: ['MAIO', 'MAI'] },
            { order: 5, keywords: ['JUNHO', 'JUN'] },
            { order: 6, keywords: ['JULHO', 'JUL'] },
            { order: 7, keywords: ['AGOSTO', 'AGO'] },
            { order: 8, keywords: ['SETEMBRO', 'SET', 'SEP'] },
            { order: 9, keywords: ['OUTUBRO', 'OUT', 'OCT'] },
            { order: 10, keywords: ['NOVEMBRO', 'NOV'] },
            { order: 11, keywords: ['DEZEMBRO', 'DEZ', 'DEC'] }
        ]);

        function normalizeHeaderForMonth(header) {
            if (header === null || typeof header === 'undefined') {
                return '';
            }

            return header.toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toUpperCase();
        }

        function detectMonthInfo(header) {
            const normalizedHeader = normalizeHeaderForMonth(header);
            if (!normalizedHeader) {
                return null;
            }

            for (const pattern of monthDetectionPatterns) {
                for (const keyword of pattern.keywords) {
                    if (normalizedHeader.includes(keyword)) {
                        return {
                            order: pattern.order,
                            keyword,
                            normalizedHeader
                        };
                    }
                }
            }

            return null;
        }

        function normalizeFamilyKey(family) {
            return (family || '').toString().trim().toLowerCase();
        }

        function sanitizeHexColor(color) {
            if (typeof color !== 'string') {
                return null;
            }

            const trimmed = color.trim();
            if (!trimmed) {
                return null;
            }

            const hex = trimmed.replace(/^#/, '');
            if (!/^[0-9a-fA-F]{3}$|^[0-9a-fA-F]{6}$/.test(hex)) {
                return null;
            }

            const normalized = hex.length === 3
                ? hex.split('').map(function(char) { return char + char; }).join('')
                : hex.toLowerCase();

            return `#${normalized}`;
        }

        function componentToHex(value) {
            const clamped = Math.min(255, Math.max(0, Math.round(value)));
            return clamped.toString(16).padStart(2, '0');
        }

        function shiftHexColor(color, amount) {
            const base = sanitizeHexColor(color);
            if (!base) {
                return null;
            }

            const normalized = base.slice(1);
            const r = parseInt(normalized.slice(0, 2), 16);
            const g = parseInt(normalized.slice(2, 4), 16);
            const b = parseInt(normalized.slice(4, 6), 16);
            const delta = Math.round(255 * amount);

            const newR = componentToHex(r + delta);
            const newG = componentToHex(g + delta);
            const newB = componentToHex(b + delta);

            return `#${newR}${newG}${newB}`;
        }

        function getReadableTextColor(color) {
            const base = sanitizeHexColor(color);
            if (!base) {
                return '#ffffff';
            }

            const r = parseInt(base.slice(1, 3), 16);
            const g = parseInt(base.slice(3, 5), 16);
            const b = parseInt(base.slice(5, 7), 16);
            const yiq = (r * 299 + g * 587 + b * 114) / 1000;

            return yiq >= 160 ? '#1f2933' : '#ffffff';
        }

        function buildFamilyAccent(baseColor) {
            const sanitizedBase = sanitizeHexColor(baseColor) || familyAccentFallback;
            const mid = shiftHexColor(sanitizedBase, -0.12) || sanitizedBase;
            const dark = shiftHexColor(sanitizedBase, -0.24) || mid;
            const chipBackground = shiftHexColor(sanitizedBase, 0.18) || sanitizedBase;
            const textColor = getReadableTextColor(sanitizedBase);
            const subTextColor = textColor === '#ffffff'
                ? 'rgba(255, 255, 255, 0.85)'
                : 'rgba(31, 41, 51, 0.72)';

            return {
                gradient: `linear-gradient(135deg, ${sanitizedBase} 0%, ${mid} 55%, ${dark} 100%)`,
                text: textColor,
                subText: subTextColor,
                chipBackground,
                chipText: getReadableTextColor(chipBackground)
            };
        }

        function getFamilyAccent(family) {
            const key = normalizeFamilyKey(family);
            if (!key) {
                return null;
            }

            if (familyAccentAssignments.has(key)) {
                return familyAccentAssignments.get(key);
            }

            const overrideColor = familyAccentOverrides.get(key);
            const paletteIndex = familyAccentAssignments.size % familyAccentPalette.length;
            const baseColor = overrideColor || familyAccentPalette[paletteIndex] || familyAccentFallback;
            const accent = buildFamilyAccent(baseColor);
            familyAccentAssignments.set(key, accent);

            return accent;
        }

        function initializeFamilyAccentConfig() {
            const fallbackDefault = '#1d396e';
            let fallbackColor = sanitizeHexColor(fallbackDefault) || '#1d396e';

            const sanitizedDefaultPalette = defaultFamilyAccentPalette
                .map(sanitizeHexColor)
                .filter(Boolean);

            const overrides = new Map();
            defaultFamilyAccentOverrides.forEach(function(entry) {
                if (!Array.isArray(entry) || entry.length < 2) {
                    return;
                }

                const familyName = entry[0];
                const color = sanitizeHexColor(entry[1]);
                const normalizedName = normalizeFamilyKey(familyName);

                if (normalizedName && color) {
                    overrides.set(normalizedName, color);
                }
            });

            const globalConfig = (typeof window !== 'undefined' && window.DASHBOARD_CONFIG && typeof window.DASHBOARD_CONFIG === 'object')
                ? window.DASHBOARD_CONFIG.familyColors
                : null;

            let palette = sanitizedDefaultPalette.slice();

            if (globalConfig && typeof globalConfig === 'object') {
                if (Array.isArray(globalConfig.palette)) {
                    const sanitizedUserPalette = globalConfig.palette
                        .map(sanitizeHexColor)
                        .filter(Boolean);

                    if (sanitizedUserPalette.length > 0) {
                        palette = sanitizedUserPalette;
                    }
                }

                if (globalConfig.overrides && typeof globalConfig.overrides === 'object') {
                    Object.keys(globalConfig.overrides).forEach(function(familyName) {
                        const normalizedName = normalizeFamilyKey(familyName);
                        const color = sanitizeHexColor(globalConfig.overrides[familyName]);

                        if (normalizedName && color) {
                            overrides.set(normalizedName, color);
                        }
                    });
                }

                if (globalConfig.fallback) {
                    const sanitizedFallback = sanitizeHexColor(globalConfig.fallback);
                    if (sanitizedFallback) {
                        fallbackColor = sanitizedFallback;
                    }
                }
            }

            if (!Array.isArray(palette) || palette.length === 0) {
                palette = sanitizedDefaultPalette.length > 0 ? sanitizedDefaultPalette : [fallbackColor];
            }

            if (palette.length === 0) {
                palette = [fallbackColor];
            }

            return {
                palette: Object.freeze(palette.slice()),
                overrides,
                fallback: fallbackColor
            };
        }

        function isMonthHeader(header) {
            return detectMonthInfo(header) !== null;
        }

        function hasMeaningfulValue(value) {
            return value !== null && typeof value !== 'undefined' && String(value).trim() !== '';
        }

        function sortMonthlyValues(values) {
            if (!Array.isArray(values)) {
                return [];
            }

            return values.slice().sort(function(a, b) {
                const infoA = detectMonthInfo(a && a.label);
                const infoB = detectMonthInfo(b && b.label);
                const orderA = infoA ? infoA.order : Number.MAX_SAFE_INTEGER;
                const orderB = infoB ? infoB.order : Number.MAX_SAFE_INTEGER;

                if (orderA === orderB) {
                    const labelA = (a && a.label) ? a.label.toString() : '';
                    const labelB = (b && b.label) ? b.label.toString() : '';
                    return labelA.localeCompare(labelB, 'pt-BR', { sensitivity: 'base', numeric: true });
                }

                return orderA - orderB;
            });
        }

        function cloneMonthlyValues(values) {
            if (!Array.isArray(values)) {
                return [];
            }

            return values.map(function(entry) {
                if (!entry || typeof entry !== 'object') {
                    return { label: '', value: 0, rawValue: '' };
                }

                const numericValue = Number(entry.value);
                const parsedValue = Number.isFinite(numericValue) ? numericValue : parseNumber(entry.value);
                const rawValue = typeof entry.rawValue !== 'undefined' ? entry.rawValue : entry.value;

                return {
                    label: entry.label ? entry.label.toString() : '',
                    value: Number.isFinite(parsedValue) ? parsedValue : 0,
                    rawValue: rawValue
                };
            });
        }

        function aggregateMonthlyValues(existingValues, newValues) {
            const aggregated = new Map();

            (Array.isArray(existingValues) ? existingValues : []).forEach(function(entry) {
                if (!entry || !entry.label) return;
                aggregated.set(entry.label, {
                    label: entry.label,
                    value: Number.isFinite(entry.value) ? entry.value : parseNumber(entry.value),
                    rawValue: typeof entry.rawValue !== 'undefined' ? entry.rawValue : entry.value
                });
            });

            (Array.isArray(newValues) ? newValues : []).forEach(function(entry) {
                if (!entry || !entry.label) return;
                aggregated.set(entry.label, {
                    label: entry.label,
                    value: Number.isFinite(entry.value) ? entry.value : parseNumber(entry.value),
                    rawValue: typeof entry.rawValue !== 'undefined' ? entry.rawValue : entry.value
                });
            });

            return sortMonthlyValues(Array.from(aggregated.values()));
        }

        function createHistoryEntry(product, sheetName) {
            const months = cloneMonthlyValues(product.sheetMonthlyValues);
            const totalStock = Number(product.stock14 || 0) + Number(product.stock9013 || 0) + Number(product.stock9015 || 0);
            const coverageValue = getCoverageValue(product);
            const historyCoverageSource = resolveCoverageSource(product);

            return {
                sheetName: sheetName || '',
                months: months,
                totals: {
                    stock14: Number(product.stock14) || 0,
                    stock9013: Number(product.stock9013) || 0,
                    stock9015: Number(product.stock9015) || 0,
                    totalStock: Number.isFinite(totalStock) ? totalStock : 0,
                    vendas4M: Number(product.vendas4M) || 0,
                    media3M: Number(product.media3M) || 0,
                    cobertura: Number.isFinite(coverageValue) ? coverageValue : 0
                },
                coverageSource: historyCoverageSource
            };
        }

        function buildFallbackMonthlyValues(product) {
            if (!product || typeof product !== 'object') {
                return [];
            }

            const fallback = [];

            Object.keys(product).forEach(function(key) {
                if (!key) return;
                const info = detectMonthInfo(key);
                if (!info) return;

                const value = product[key];
                if (!hasMeaningfulValue(value)) return;

                const numericValue = parseNumber(value);
                fallback.push({
                    label: key.toString().replace(/_/g, ' ').toUpperCase(),
                    value: Number.isFinite(numericValue) ? numericValue : 0,
                    rawValue: value
                });
            });

            return sortMonthlyValues(fallback);
        }

        function normalizeHistoryEntry(entry) {
            if (!entry || typeof entry !== 'object') {
                return {
                    sheetName: '',
                    months: [],
                    totals: {
                        stock14: 0,
                        stock9013: 0,
                        stock9015: 0,
                        totalStock: 0,
                        vendas4M: 0,
                        media3M: 0,
                        cobertura: 0
                    },
                    coverageSource: 'none'
                };
            }

            const normalizedTotals = Object.assign({
                stock14: 0,
                stock9013: 0,
                stock9015: 0,
                totalStock: 0,
                vendas4M: 0,
                media3M: 0,
                cobertura: 0
            }, entry.totals || {});

            const normalizedCoverageSource = entry.coverageSource || 'none';

            normalizedTotals.stock14 = Number.isFinite(Number(normalizedTotals.stock14))
                ? Number(normalizedTotals.stock14)
                : parseNumber(normalizedTotals.stock14);
            normalizedTotals.stock9013 = Number.isFinite(Number(normalizedTotals.stock9013))
                ? Number(normalizedTotals.stock9013)
                : parseNumber(normalizedTotals.stock9013);
            normalizedTotals.stock9015 = Number.isFinite(Number(normalizedTotals.stock9015))
                ? Number(normalizedTotals.stock9015)
                : parseNumber(normalizedTotals.stock9015);
            normalizedTotals.vendas4M = Number.isFinite(Number(normalizedTotals.vendas4M))
                ? Number(normalizedTotals.vendas4M)
                : parseNumber(normalizedTotals.vendas4M);
            normalizedTotals.media3M = Number.isFinite(Number(normalizedTotals.media3M))
                ? Number(normalizedTotals.media3M)
                : parseNumber(normalizedTotals.media3M);
            normalizedTotals.cobertura = Number.isFinite(Number(normalizedTotals.cobertura))
                ? Number(normalizedTotals.cobertura)
                : parseNumber(normalizedTotals.cobertura);
            normalizedTotals.totalStock = Number.isFinite(Number(normalizedTotals.totalStock))
                ? Number(normalizedTotals.totalStock)
                : (normalizedTotals.stock14 + normalizedTotals.stock9013 + normalizedTotals.stock9015);

            return {
                sheetName: entry.sheetName || '',
                months: sortMonthlyValues(cloneMonthlyValues(entry.months)),
                totals: normalizedTotals,
                coverageSource: normalizedCoverageSource
            };
        }

        function ensureProductHistoryStructure(product) {
            if (!product || typeof product !== 'object') {
                return product;
            }

            if (Array.isArray(product.monthlyValues) && product.monthlyValues.length > 0) {
                product.monthlyValues = sortMonthlyValues(cloneMonthlyValues(product.monthlyValues));
            } else {
                product.monthlyValues = buildFallbackMonthlyValues(product);
            }

            if (Array.isArray(product.importHistory) && product.importHistory.length > 0) {
                product.importHistory = product.importHistory.map(normalizeHistoryEntry);
            } else {
                product.importHistory = [];
            }

            const hasCobertura = Number.isFinite(product.cobertura);
            const hasStockMonths = Number.isFinite(product.stockMonths);

            if (!product.coverageSource || product.coverageSource === 'stockMonths' || product.coverageSource === 'cobertura') {
                if (hasCobertura) {
                    product.coverageSource = 'cobertura';
                } else if (hasStockMonths) {
                    product.coverageSource = 'stockMonths';
                } else {
                    product.coverageSource = 'none';
                }
            }

            return product;
        }

        function formatHistoryDisplayValue(entry) {
            if (!entry || typeof entry !== 'object') {
                return '--';
            }

            const raw = entry.rawValue;
            if (typeof raw === 'string') {
                const trimmedRaw = raw.trim();
                if (!trimmedRaw || trimmedRaw === '--') {
                    return '--';
                }

                if (/^-?[0-9.,]+$/.test(trimmedRaw)) {
                    const numeric = parseNumber(trimmedRaw);
                    return Number.isFinite(numeric)
                        ? numeric.toLocaleString('pt-BR')
                        : escapeTooltip(trimmedRaw);
                }

                return escapeTooltip(trimmedRaw);
            }

            if (typeof raw === 'number' && Number.isFinite(raw)) {
                return raw.toLocaleString('pt-BR');
            }

            if (Number.isFinite(entry.value)) {
                return entry.value.toLocaleString('pt-BR');
            }

            return '--';
        }

        function ensureTooltipElement() {
            if (!tooltipElement) {
                tooltipElement = document.createElement('div');
                tooltipElement.className = 'tooltip-bubble';
                tooltipElement.setAttribute('role', 'tooltip');
                tooltipElement.setAttribute('aria-hidden', 'true');
                tooltipElement.dataset.position = 'bottom';
                document.body.appendChild(tooltipElement);
            }
        }

        function positionTooltip(target) {
            if (!tooltipElement || !target) {
                return;
            }

            const rect = target.getBoundingClientRect();
            const desiredPosition = target.getAttribute('data-tooltip-position');
            const prefersTop = desiredPosition !== 'bottom';
            tooltipElement.style.maxWidth = `min(320px, ${Math.max(200, window.innerWidth - 32)}px)`;

            const tooltipRect = tooltipElement.getBoundingClientRect();
            const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
            const scrollX = window.scrollX || document.documentElement.scrollLeft || 0;
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            const minTop = scrollY + 8;
            const maxTop = scrollY + viewportHeight - tooltipRect.height - 8;

            const computeTop = function(position) {
                const referenceTop = rect.top + scrollY;
                const referenceBottom = rect.bottom + scrollY;
                return position === 'top'
                    ? referenceTop - tooltipRect.height - 10
                    : referenceBottom + 10;
            };

            let position = prefersTop ? 'top' : 'bottom';
            let top = computeTop(position);

            if (top < minTop) {
                position = 'bottom';
                top = computeTop(position);
            }

            if (top > maxTop) {
                position = 'top';
                top = computeTop(position);
            }

            top = Math.min(Math.max(top, minTop), maxTop);

            const centerX = rect.left + scrollX + (rect.width / 2);
            let left = centerX - (tooltipRect.width / 2);
            const minLeft = scrollX + 8;
            const maxLeft = scrollX + viewportWidth - tooltipRect.width - 8;
            left = Math.min(Math.max(left, minLeft), maxLeft);

            tooltipElement.dataset.position = position;
            tooltipElement.style.top = `${top}px`;
            tooltipElement.style.left = `${left}px`;

            const arrowLeft = centerX - left;
            tooltipElement.style.setProperty('--tooltip-arrow-left', `${Math.min(Math.max(arrowLeft, 12), tooltipRect.width - 12)}px`);
        }

        function showTooltip(target) {
            if (!target || !target.getAttribute('data-tooltip')) {
                return;
            }

            ensureTooltipElement();
            tooltipElement.textContent = target.getAttribute('data-tooltip');
            tooltipElement.setAttribute('aria-hidden', 'false');
            tooltipElement.classList.add('visible');
            activeTooltipTarget = target;
            positionTooltip(target);
        }

        function hideTooltip() {
            if (!tooltipElement) {
                return;
            }

            tooltipElement.classList.remove('visible');
            tooltipElement.setAttribute('aria-hidden', 'true');
            activeTooltipTarget = null;
        }

        function handleTooltipEnter(event) {
            clearTimeout(tooltipHideTimeout);
            showTooltip(event.currentTarget);
        }

        function handleTooltipLeave() {
            clearTimeout(tooltipHideTimeout);
            tooltipHideTimeout = setTimeout(hideTooltip, 80);
        }

        function handleTooltipFocus(event) {
            clearTimeout(tooltipHideTimeout);
            showTooltip(event.currentTarget);
        }

        function handleTooltipBlur() {
            clearTimeout(tooltipHideTimeout);
            hideTooltip();
        }

        function bindTooltip(target) {
            if (!target || target.dataset.tooltipBound === 'true') {
                return;
            }

            target.dataset.tooltipBound = 'true';
            target.addEventListener('mouseenter', handleTooltipEnter);
            target.addEventListener('mouseleave', handleTooltipLeave);
            target.addEventListener('focus', handleTooltipFocus);
            target.addEventListener('blur', handleTooltipBlur);
        }

        function initializeTooltips(root) {
            const scope = root || document;
            const elements = scope.querySelectorAll('.has-tooltip');
            elements.forEach(bindTooltip);
        }

        window.addEventListener('scroll', function() {
            if (activeTooltipTarget) {
                positionTooltip(activeTooltipTarget);
            }
        }, true);

        window.addEventListener('resize', function() {
            if (activeTooltipTarget) {
                positionTooltip(activeTooltipTarget);
            }
        });

        // Fun√ß√£o de log para debug
        function debugLog(message, type) {
            type = type || 'info';
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            console.log(logMessage);
            
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                if (debugDiv) {
                    debugDiv.innerHTML += logMessage + '<br>';
                    debugDiv.scrollTop = debugDiv.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.style.display = debugMode ? 'block' : 'none';
                if (debugMode) {
                    debugDiv.innerHTML = '<strong>üêõ DEBUG MODE ATIVADO</strong><br>';
                    debugLog('Debug mode ativado');
                }
            }
        }

        function toggleMappingDebug() {
            mappingDebugMode = !mappingDebugMode;
            const mappingDiv = document.getElementById('mappingDebug');
            if (mappingDiv) {
                mappingDiv.style.display = mappingDebugMode ? 'block' : 'none';
                if (mappingDebugMode && lastMappingInfo) {
                    showMappingInfo(lastMappingInfo);
                }
            }
        }

        function showMappingInfo(mappingInfo) {
            const mappingDiv = document.getElementById('mappingDebug');
            if (!mappingDiv || !mappingDebugMode) return;

            let html = '<strong>üìã INFORMA√á√ïES DE MAPEAMENTO DE COLUNAS</strong><br><br>';
            html += `<strong>Colunas encontradas na planilha:</strong><br>`;
            mappingInfo.headers.forEach((header, index) => {
                html += `[${index}] "${header}"<br>`;
            });

            html += '<br><strong>Mapeamento aplicado:</strong><br>';
            for (const [field, index] of Object.entries(mappingInfo.mapping)) {
                const header = mappingInfo.headers[index] || '√çNDICE INV√ÅLIDO';
                const status = mappingInfo.headers[index] ? '‚úÖ' : '‚ùå';
                html += `${field} ‚Üí [${index}] "${header}" ${status}<br>`;
            }

            if (mappingInfo.warnings.length > 0) {
                html += '<br><strong>‚ö†Ô∏è Avisos:</strong><br>';
                mappingInfo.warnings.forEach(warning => {
                    html += `${warning}<br>`;
                });
            }

            mappingDiv.innerHTML = html;
        }

        function getConfigValue(path, fallback) {
            if (typeof getConfig === 'function') {
                const value = getConfig(path);
                if (typeof value !== 'undefined') {
                    return value;
                }
            } else if (window.dashboardConfig) {
                const keys = path.split('.');
                let current = window.dashboardConfig;
                for (const key of keys) {
                    if (current && typeof current === 'object' && key in current) {
                        current = current[key];
                    } else {
                        current = undefined;
                        break;
                    }
                }
                if (typeof current !== 'undefined') {
                    return current;
                }
            }

            return fallback;
        }

        function getPredictionSettings() {
            const defaults = { urgentDays: 30, warningDays: 60 };
            const configValues = getConfigValue('predictions', {}) || {};
            return Object.assign({}, defaults, {
                urgentDays: typeof configValues.urgentDays === 'number' ? configValues.urgentDays : defaults.urgentDays,
                warningDays: typeof configValues.warningDays === 'number' ? configValues.warningDays : defaults.warningDays
            });
        }

        function getReorderPointValue() {
            const reorder = getConfigValue('stockLevels.reorderPoint', null);
            return typeof reorder === 'number' ? reorder : null;
        }

        function calculateDailyDemand(product) {
            const monthlyAverage = product.media3M && product.media3M > 0
                ? product.media3M
                : (product.vendas4M && product.vendas4M > 0 ? product.vendas4M / 4 : 0);

            if (monthlyAverage > 0) {
                return monthlyAverage / 30;
            }

            if (product.stockMonths && product.stockMonths > 0) {
                const totalStock = (product.stock14 || 0) + (product.stock9013 || 0) + (product.stock9015 || 0);
                const inferredDaily = totalStock / (product.stockMonths * 30);
                return isFinite(inferredDaily) && inferredDaily > 0 ? inferredDaily : 0;
            }

            return 0;
        }

        function getCoverageInfo(product) {
            const stockAvailable = getProductStock(product);
            const dailyDemand = calculateDailyDemand(product);

            if (stockAvailable <= 0) {
                return {
                    stockAvailable,
                    dailyDemand,
                    daysToDepletion: 0,
                    hasDemand: dailyDemand > 0,
                    outOfStock: true
                };
            }

            if (dailyDemand <= 0) {
                return {
                    stockAvailable,
                    dailyDemand,
                    daysToDepletion: null,
                    hasDemand: false,
                    outOfStock: false
                };
            }

            return {
                stockAvailable,
                dailyDemand,
                daysToDepletion: stockAvailable / dailyDemand,
                hasDemand: true,
                outOfStock: false
            };
        }

        function formatStatValue(value, digits = 1) {
            if (value === null || typeof value === 'undefined' || Number.isNaN(value)) {
                return '--';
            }

            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: digits,
                maximumFractionDigits: digits
            }).format(value);
        }

        function formatIntegerValue(value) {
            if (!Number.isFinite(value)) {
                return '0';
            }

            return Math.round(value).toLocaleString('pt-BR');
        }

        function formatCoverageDisplay(value) {
            if (!Number.isFinite(value)) {
                return {
                    displayValue: '--',
                    unitLabel: '',
                    unitType: null
                };
            }

            if (value === 0) {
                return {
                    displayValue: '0',
                    unitLabel: 'meses',
                    unitType: 'months'
                };
            }

            const months = value;
            const totalDays = months * 30;
            const absDays = Math.abs(totalDays);

            const formatNumber = function(number, maxFractionDigits) {
                if (!Number.isFinite(number)) {
                    return '--';
                }

                const absNumber = Math.abs(number);
                let digits;
                if (absNumber >= 100) {
                    digits = 0;
                } else if (absNumber >= 10) {
                    digits = Math.min(maxFractionDigits, 1);
                } else {
                    digits = maxFractionDigits;
                }

                const factor = Math.pow(10, digits);
                const rounded = factor > 0 ? Math.round(number * factor) / factor : Math.round(number);
                const hasFraction = Math.abs(rounded - Math.round(rounded)) > 1e-6;
                const fractionDigits = hasFraction ? digits : 0;

                return new Intl.NumberFormat('pt-BR', {
                    minimumFractionDigits: fractionDigits,
                    maximumFractionDigits: fractionDigits
                }).format(rounded);
            };

            const isApproximatelyOne = function(number) {
                return Math.abs(Math.abs(number) - 1) < 1e-6;
            };

            if (absDays >= 365) {
                const years = months / 12;
                return {
                    displayValue: formatNumber(years, 1),
                    unitLabel: Math.abs(years) >= 2 ? 'anos' : 'ano',
                    unitType: 'years'
                };
            }

            if (absDays >= 30) {
                return {
                    displayValue: formatNumber(months, 1),
                    unitLabel: Math.abs(months) >= 2 ? 'meses' : 'm√™s',
                    unitType: 'months'
                };
            }

            if (absDays >= 1) {
                return {
                    displayValue: formatNumber(totalDays, 1),
                    unitLabel: isApproximatelyOne(totalDays) ? 'dia' : 'dias',
                    unitType: 'days'
                };
            }

            const totalHours = totalDays * 24;
            const absHours = Math.abs(totalHours);

            if (absHours >= 1) {
                return {
                    displayValue: formatNumber(totalHours, 1),
                    unitLabel: isApproximatelyOne(totalHours) ? 'hora' : 'horas',
                    unitType: 'hours'
                };
            }

            const totalMinutes = Math.round(totalHours * 60);
            return {
                displayValue: new Intl.NumberFormat('pt-BR').format(totalMinutes),
                unitLabel: Math.abs(totalMinutes) === 1 ? 'minuto' : 'minutos',
                unitType: 'minutes'
            };
        }

        function resolveCoverageSource(product) {
            if (!product || typeof product !== 'object') {
                return 'none';
            }

            if (typeof product.coverageSource === 'string' && product.coverageSource) {
                if (product.coverageSource === 'estimated') {
                    return 'calculated';
                }
                if (product.coverageSource === 'cobertura' && Number.isFinite(product.cobertura)) {
                    return 'cobertura';
                }
                if (product.coverageSource === 'stockMonths' && Number.isFinite(product.stockMonths)) {
                    return 'stockMonths';
                }
                if (Number.isFinite(product.cobertura)) {
                    return 'cobertura';
                }
                if (Number.isFinite(product.stockMonths)) {
                    return 'stockMonths';
                }
                return product.coverageSource;
            }

            if (Number.isFinite(product.cobertura)) {
                return 'cobertura';
            }

            if (Number.isFinite(product.stockMonths)) {
                return 'stockMonths';
            }

            return 'none';
        }

        function getCoverageValue(product) {
            if (!product || typeof product !== 'object') {
                return null;
            }

            const source = resolveCoverageSource(product);
            switch (source) {
                case 'cobertura':
                    return Number.isFinite(product.cobertura) ? product.cobertura : null;
                case 'stockMonths':
                    return Number.isFinite(product.stockMonths) ? product.stockMonths : null;
                case 'calculated': {
                    const coverageInfo = getCoverageInfo(product);
                    if (coverageInfo && Number.isFinite(coverageInfo.daysToDepletion)) {
                        return coverageInfo.daysToDepletion / 30;
                    }
                    return null;
                }
                default:
                    if (Number.isFinite(product.cobertura)) {
                        return product.cobertura;
                    }
                    if (Number.isFinite(product.stockMonths)) {
                        return product.stockMonths;
                    }
                    return null;
            }
        }

        function getCoverageSourceMetadata(product) {
            const sourceKey = resolveCoverageSource(product);
            const coverageValue = getCoverageValue(product);
            const hasCoverageData = sourceKey !== 'none' && Number.isFinite(coverageValue);

            if (!hasCoverageData && sourceKey === 'none') {
                return {
                    key: 'none',
                    label: 'Sem dados',
                    detail: 'Nenhuma informa√ß√£o de cobertura dispon√≠vel.',
                    className: 'no-data'
                };
            }

            switch (sourceKey) {
                case 'stockMonths':
                    return {
                        key: 'stockMonths',
                        label: 'Dados importados',
                        detail: 'Estoque em meses fornecido no arquivo',
                        className: 'from-import'
                    };
                case 'cobertura':
                    return {
                        key: 'cobertura',
                        label: 'Dados importados',
                        detail: 'Cobertura fornecida no arquivo',
                        className: 'from-import'
                    };
                case 'calculated':
                    return {
                        key: 'calculated',
                        label: 'Estimativa autom√°tica',
                        detail: 'Proje√ß√£o baseada no consumo e no estoque atual',
                        className: 'from-estimate'
                    };
                default:
                    return {
                        key: 'none',
                        label: 'Sem dados',
                        detail: 'Nenhuma informa√ß√£o de cobertura dispon√≠vel.',
                        className: 'no-data'
                    };
            }
        }

        function escapeTooltip(text) {
            if (text === null || typeof text === 'undefined') {
                return '';
            }

            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function applyPredictionLabels() {
            const { urgentDays, warningDays } = getPredictionSettings();
            const urgentLabel = document.getElementById('urgentDaysLabel');
            const warningLabel = document.getElementById('warningDaysLabel');
            const reorderElement = document.getElementById('reorderPoint');
            const reorderPointValue = getReorderPointValue();

            if (urgentLabel) {
                urgentLabel.textContent = urgentDays;
            }

            if (warningLabel) {
                warningLabel.textContent = warningDays;
            }

            if (reorderElement) {
                reorderElement.textContent = typeof reorderPointValue === 'number'
                    ? `${reorderPointValue} meses`
                    : '--';
            }
        }

        // Detectar suporte ao File System Access API
        function detectBrowserCapabilities() {
            debugLog('Iniciando detec√ß√£o de capacidades do navegador');
            
            try {
                const isFileProtocol = location.protocol === 'file:';
                const isHttps = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                
                debugLog(`Protocolo atual: ${location.protocol}`);
                debugLog(`√â file://: ${isFileProtocol}`);
                debugLog(`√â HTTPS: ${isHttps}`);
                debugLog(`√â localhost: ${isLocalhost}`);
                
                const hasAPI = 'showDirectoryPicker' in window;
                debugLog(`showDirectoryPicker dispon√≠vel: ${hasAPI}`);
                
                const userAgent = navigator.userAgent;
                const isChrome = userAgent.includes('Chrome') && !userAgent.includes('Edg');
                const isEdge = userAgent.includes('Edg');
                debugLog(`Navegador detectado - Chrome: ${isChrome}, Edge: ${isEdge}`);
                
                const isSecureContext = !isFileProtocol && (isHttps || isLocalhost);
                fileSystemSupported = hasAPI && isSecureContext && (isChrome || isEdge);
                debugLog(`File System API suportado: ${fileSystemSupported}`);
                
                const indicator = document.getElementById('browserModeIndicator');
                
                if (!indicator) {
                    debugLog('Elemento browserModeIndicator n√£o encontrado', 'warn');
                    return;
                }
                
                if (isFileProtocol) {
                    indicator.innerHTML = `
                        <div style="text-align: left;">
                            üîç <strong>Modo Arquivo Local</strong> - Salvamento autom√°tico n√£o dispon√≠vel<br>
                            üí° <strong>Para ativar salvamento autom√°tico:</strong><br>
                            ‚Ä¢ Use um servidor web local (Live Server, http-server, etc.)<br>
                            ‚Ä¢ Ou acesse via https://seu-site.com<br>
                            ‚Ä¢ Use o bot√£o "üíæ Baixar data.js" para salvar manualmente
                        </div>
                    `;
                    indicator.style.background = '#e7f3ff';
                    indicator.style.color = '#0066cc';
                    indicator.style.padding = '12px';
                    indicator.style.borderLeft = '4px solid #0066cc';
                    debugLog('Modo file:// detectado - salvamento autom√°tico desabilitado');
                    
                } else if (fileSystemSupported) {
                    indicator.innerHTML = '‚ú® Salvamento autom√°tico dispon√≠vel! (Chrome/Edge + Servidor Web)';
                    indicator.style.background = '#d4edda';
                    indicator.style.color = '#155724';
                    
                    setTimeout(function() {
                        const autoSaveBtn = document.getElementById('autoSaveBtn');
                        const testBtn = document.getElementById('testBtn');
                        
                        if (autoSaveBtn) {
                            autoSaveBtn.style.display = 'inline-block';
                            autoSaveBtn.classList.add('ready');
                            debugLog('Bot√£o autoSave mostrado');
                        }
                        
                        if (testBtn) {
                            testBtn.style.display = 'inline-block';
                        }
                    }, 300);
                } else {
                    let reason = '';
                    let solution = '';
                    
                    if (!hasAPI) {
                        reason = 'API n√£o suportada neste navegador';
                        solution = 'Use Chrome ou Edge atualizado';
                    } else if (!isSecureContext) {
                        reason = 'Requer conex√£o segura (HTTPS ou localhost)';
                        solution = 'Use um servidor web local ou HTTPS';
                    } else if (!isChrome && !isEdge) {
                        reason = 'Navegador n√£o suportado';
                        solution = 'Use Chrome ou Edge';
                    }
                    
                    indicator.innerHTML = `
                        <div style="text-align: left;">
                            ‚ö†Ô∏è <strong>Salvamento autom√°tico n√£o dispon√≠vel</strong><br>
                            üîç <strong>Motivo:</strong> ${reason}<br>
                            üí° <strong>Solu√ß√£o:</strong> ${solution}<br>
                            üî• Use o bot√£o "üíæ Baixar data.js" para salvar manualmente
                        </div>
                    `;
                    indicator.style.background = '#fff3cd';
                    indicator.style.color = '#856404';
                    indicator.style.padding = '12px';
                    indicator.style.borderLeft = '4px solid #ffc107';
                    debugLog(`Salvamento autom√°tico n√£o dispon√≠vel: ${reason}`);
                }
            } catch (error) {
                debugLog(`Erro na detec√ß√£o de capacidades: ${error.message}`, 'error');
                fileSystemSupported = false;
            }
        }

        // Fun√ß√£o principal para configurar pasta
        function tryAutoSave() {
            debugLog('=== TENTATIVA DE CONFIGURA√á√ÉO DE PASTA ===');
            
            if (location.protocol === 'file:') {
                const msg = `
                    ‚ö†Ô∏è Salvamento autom√°tico n√£o funciona com arquivos locais (file://)
                    
                    üí° Para ativar esta funcionalidade:
                    ‚Ä¢ Use um servidor web local (Live Server, Python, etc.)
                    ‚Ä¢ Acesse via http://localhost ou https://
                    
                    üî• Por enquanto, use "üíæ Baixar data.js" para salvar manualmente
                `;
                showMessage(msg, 'warning');
                debugLog('Tentativa de uso em protocolo file:// - n√£o suportado', 'warn');
                
                const downloadBtn = document.querySelector('button[onclick="downloadDataFile()"]');
                if (downloadBtn) {
                    downloadBtn.style.animation = 'pulse 2s infinite';
                    setTimeout(() => {
                        downloadBtn.style.animation = '';
                    }, 5000);
                }
                return;
            }
            
            if (!fileSystemSupported) {
                const msg = '‚ùå Salvamento autom√°tico n√£o suportado neste navegador/ambiente.';
                showMessage(msg, 'error');
                debugLog(msg, 'error');
                return;
            }

            if (allProductsData.length === 0) {
                const msg = '‚ö†Ô∏è Nenhum dado para salvar. Importe uma planilha primeiro.';
                showMessage(msg, 'warning');
                debugLog(msg, 'warn');
                return;
            }

            debugLog('Solicitando sele√ß√£o de pasta ao usu√°rio');
            
            window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            }).then(function(handle) {
                debugLog('Pasta selecionada com sucesso');
                directoryHandle = handle;
                
                showMessage('‚úÖ Pasta configurada! Salvando arquivo...', 'success');
                updateUI();
                
                return saveDataAutomatically();
                
            }).then(function(success) {
                if (success) {
                    showMessage('‚ú® Arquivo data.js salvo automaticamente na pasta selecionada!', 'success');
                    debugLog('Salvamento autom√°tico conclu√≠do com sucesso');
                } else {
                    showMessage('‚ùå Erro ao salvar o arquivo. Verifique as permiss√µes.', 'error');
                    debugLog('Falha no salvamento autom√°tico', 'error');
                }
            }).catch(function(error) {
                if (error.name === 'AbortError') {
                    debugLog('Usu√°rio cancelou a sele√ß√£o de pasta');
                    showMessage('‚ùå Sele√ß√£o de pasta cancelada pelo usu√°rio.', 'info');
                } else {
                    debugLog(`Erro no processo: ${error.message}`, 'error');
                    showMessage(`‚ùå Erro: ${error.message}`, 'error');
                }
            });
        }

        function reconfigureAutoSave() {
            debugLog('Reconfigurando pasta para salvamento autom√°tico');
            directoryHandle = null;
            tryAutoSave();
        }

        function saveDataAutomatically() {
            return new Promise(function(resolve, reject) {
                debugLog('=== INICIANDO SALVAMENTO AUTOM√ÅTICO ===');
                
                if (!directoryHandle) {
                    debugLog('directoryHandle n√£o configurado', 'error');
                    resolve(false);
                    return;
                }
                
                if (allProductsData.length === 0) {
                    debugLog('Nenhum dado para salvar', 'error');
                    resolve(false);
                    return;
                }

                try {
                    debugLog('Gerando conte√∫do do arquivo data.js');
                    const dataContent = saveDataToFile(allProductsData);
                    debugLog(`Conte√∫do gerado: ${dataContent.length} caracteres`);
                    
                    debugLog('Verificando permiss√µes de escrita');
                    directoryHandle.requestPermission({ mode: 'readwrite' }).then(function(permission) {
                        debugLog(`Permiss√£o obtida: ${permission}`);
                        
                        if (permission !== 'granted') {
                            throw new Error('Permiss√£o de escrita negada');
                        }
                        
                        debugLog('Criando/obtendo arquivo data.js');
                        return directoryHandle.getFileHandle('data.js', { create: true });
                        
                    }).then(function(fileHandle) {
                        debugLog('Arquivo obtido, criando stream de escrita');
                        return fileHandle.createWritable();
                        
                    }).then(function(writable) {
                        debugLog('Escrevendo conte√∫do no arquivo');
                        return writable.write(dataContent).then(function() {
                            debugLog('Fechando arquivo');
                            return writable.close();
                        });
                        
                    }).then(function() {
                        debugLog('Arquivo salvo com sucesso!');
                        
                        localStorage.setItem('stockDataTimestamp', Date.now().toString());
                        updateUI();
                        
                        resolve(true);
                        
                    }).catch(function(error) {
                        debugLog(`Erro no salvamento: ${error.message}`, 'error');
                        reject(error);
                    });
                    
                } catch (error) {
                    debugLog(`Erro na gera√ß√£o do conte√∫do: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }

        function testAutoSave() {
            debugLog('=== TESTE DE SALVAMENTO ===');
            
            if (!fileSystemSupported) {
                showMessage('‚ùå Salvamento autom√°tico n√£o suportado neste navegador.', 'error');
                return;
            }
            
            if (!directoryHandle) {
                showMessage('‚ö†Ô∏è Configure uma pasta primeiro clicando em "Configurar Pasta".', 'warning');
                return;
            }
            
            if (allProductsData.length === 0) {
                showMessage('‚ö†Ô∏è Nenhum dado para testar. Importe uma planilha primeiro.', 'warning');
                return;
            }
            
            saveDataAutomatically().then(function(success) {
                if (success) {
                    showMessage('‚úÖ Teste realizado! Arquivo salvo com sucesso.', 'success');
                } else {
                    showMessage('‚ùå Falha no teste de salvamento.', 'error');
                }
            }).catch(function(error) {
                showMessage(`‚ùå Erro no teste: ${error.message}`, 'error');
            });
        }

        function updateUI() {
            debugLog('Atualizando interface do usu√°rio');
            
            try {
                const lastUpdateDiv = document.getElementById('lastUpdateInfo');
                if (!lastUpdateDiv) {
                    debugLog('Elemento lastUpdateInfo n√£o encontrado', 'warn');
                    return;
                }
                
                let infoText = '';
                
                if (typeof window.stockMetadata !== 'undefined' && window.stockMetadata.lastUpdate) {
                    const date = new Date(window.stockMetadata.lastUpdate);
                    const formattedDate = date.toLocaleString('pt-BR');
                    infoText = `üìÖ √öltima atualiza√ß√£o: ${formattedDate}`;
                } else {
                    const storedData = localStorage.getItem('stockDataTimestamp');
                    if (storedData) {
                        const date = new Date(parseInt(storedData));
                        const formattedDate = date.toLocaleString('pt-BR');
                        infoText = `üìÖ √öltima atualiza√ß√£o: ${formattedDate}`;
                    } else {
                        infoText = 'üìÖ Nenhuma importa√ß√£o realizada ainda';
                    }
                }
                
                if (fileSystemSupported && directoryHandle) {
                    const autoSaveBtn = document.getElementById('autoSaveBtn');
                    const reconfigBtn = document.getElementById('reconfigBtn');
                    const testBtn = document.getElementById('testBtn');
                    
                    if (autoSaveBtn) {
                        autoSaveBtn.textContent = '‚ú® Salvar na Pasta';
                        autoSaveBtn.classList.remove('ready');
                    }
                    if (reconfigBtn) reconfigBtn.style.display = 'inline-block';
                    if (testBtn) testBtn.style.display = 'inline-block';
                    
                    infoText += '<br>üóÇÔ∏è <span style="color: #28a745; font-weight: bold;">Pasta configurada - salvamento autom√°tico ativo!</span>';
                } else if (fileSystemSupported) {
                    infoText += '<br>‚öôÔ∏è <span style="color: #1F448C;">Clique em "Configurar Pasta" para ativar salvamento autom√°tico</span>';
                }
                
                lastUpdateDiv.innerHTML = infoText;
                debugLog('Interface atualizada com sucesso');
                
            } catch (error) {
                debugLog(`Erro ao atualizar interface: ${error.message}`, 'error');
            }
        }

        // Carregar dados ao inicializar
        function loadData() {
            debugLog('=== CARREGANDO DADOS ===');
            
            if (typeof window.stockData !== 'undefined' && Array.isArray(window.stockData) && window.stockData.length > 0) {
                allProductsData = window.stockData.map(function(product) {
                    return ensureProductHistoryStructure(product);
                });
                debugLog(`Dados carregados do data.js: ${allProductsData.length} produtos`);
                showMessage(`‚úÖ ${allProductsData.length} produtos carregados do data.js`, 'success');
                if (typeof window.stockMetadata === 'object' && window.stockMetadata !== null) {
                    activeImportDescriptor = window.stockMetadata.source || 'data.js';
                    lastImportedFileName = window.stockMetadata.sourceFile || 'data.js';
                    lastImportedSheetName = window.stockMetadata.sheetName || '';
                } else {
                    activeImportDescriptor = 'data.js';
                    lastImportedFileName = 'data.js';
                    lastImportedSheetName = '';
                }
            } else {
                const storedData = localStorage.getItem('stockData');
                if (storedData) {
                    try {
                        const parsedData = JSON.parse(storedData);
                        allProductsData = Array.isArray(parsedData)
                            ? parsedData.map(function(product) {
                                return ensureProductHistoryStructure(product);
                            })
                            : [];
                        debugLog(`Dados carregados do localStorage: ${allProductsData.length} produtos`);
                        showMessage(`‚úÖ ${allProductsData.length} produtos carregados do backup local`, 'info');
                        activeImportDescriptor = 'backup local';
                        lastImportedFileName = 'localStorage';
                        lastImportedSheetName = '';
                    } catch (e) {
                        debugLog(`Erro ao parsear dados do localStorage: ${e.message}`, 'error');
                        allProductsData = [];
                    }
                } else {
                    allProductsData = [];
                    debugLog('Nenhum dado encontrado');
                    activeImportDescriptor = 'dados carregados';
                    lastImportedFileName = '';
                    lastImportedSheetName = '';
                }
            }

            if (allProductsData.length === 0) {
                showMessage('‚ö†Ô∏è Nenhum dado encontrado. Importe uma planilha para come√ßar.', 'info');
            }

            initializeDashboard();
        }

        function initializeDashboard() {
            debugLog('Inicializando dashboard');
            
            try {
                populateFamilyFilter();
                populateSupplierFilter();
                showAllProducts();
                updatePredictiveAnalysis();
                updateUI();
                
                debugLog('Dashboard inicializado com sucesso');
            } catch (error) {
                debugLog(`Erro ao inicializar dashboard: ${error.message}`, 'error');
                showMessage('‚ö†Ô∏è Dashboard carregado com problemas. Use o diagn√≥stico para mais detalhes.', 'warning');
            }
        }

        function saveDataToFile(data) {
            try {
                debugLog('Gerando arquivo data.js');

                const processedData = data.map(function(product) {
                    const monthlyValues = sortMonthlyValues(cloneMonthlyValues(product.monthlyValues));
                    const historyEntries = Array.isArray(product.importHistory)
                        ? product.importHistory.map(function(entry) {
                            const normalizedEntry = normalizeHistoryEntry(entry);
                            return {
                                sheetName: normalizedEntry.sheetName,
                                months: normalizedEntry.months,
                                totals: normalizedEntry.totals
                            };
                        })
                        : [];

                    return {
                        code: product.code || '',
                        supplier: product.supplier || '',
                        family: product.family || '',
                        item: product.item || '',
                        stock14: product.stock14 || 0,
                        stock9013: product.stock9013 || 0,
                        stock9015: product.stock9015 || 0,
                        stockMonths: product.stockMonths || 0,
                        vendas4M: product.vendas4M || 0,
                        media3M: product.media3M || 0,
                        novembro: product.novembro || 0,
                        dezembro: product.dezembro || 0,
                        cobertura: Number.isFinite(product.cobertura)
                            ? product.cobertura
                            : (Number.isFinite(product.stockMonths) ? product.stockMonths : 0),
                        monthlyValues: monthlyValues,
                        importHistory: historyEntries
                    };
                });

                const dataContent = `// Dados do Dashboard de Estoque v1.3 - Gerado em ${new Date().toLocaleString('pt-BR')}
// Substitua este arquivo na pasta compartilhada para atualizar os dados
console.log('Carregando data.js v1.3...');

window.stockData = ${JSON.stringify(processedData, null, 2)};

// Metadados
window.stockMetadata = {
    lastUpdate: "${new Date().toISOString()}",
    totalProducts: ${processedData.length},
    generatedBy: "Dashboard de Estoque v1.3 - Importador com m√∫ltiplas abas",
    version: "1.3.0",
    sourceFile: "${lastImportedFileName || ''}",
    sheetName: "${lastImportedSheetName || ''}",
    source: "${activeImportDescriptor || ''}"
};

console.log('data.js v1.3 carregado com', window.stockData.length, 'produtos');`;
                
                debugLog(`Arquivo gerado: ${dataContent.length} caracteres`);
                return dataContent;
            } catch (error) {
                debugLog(`Erro ao gerar arquivo: ${error.message}`, 'error');
                throw error;
            }
        }

        function extractWorkbookData(workbook, sheetName) {
            if (!workbook || !sheetName) {
                throw new Error('Dados da planilha indispon√≠veis para processamento.');
            }

            const sheet = workbook.Sheets[sheetName];
            if (!sheet) {
                throw new Error(`Aba "${sheetName}" n√£o encontrada.`);
            }

            const sheetRows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: '' });
            if (!Array.isArray(sheetRows) || sheetRows.length === 0) {
                return [];
            }

            const headers = sheetRows[0].map(function(headerCell) {
                return headerCell === null || typeof headerCell === 'undefined'
                    ? ''
                    : headerCell.toString();
            });

            const rows = sheetRows.slice(1);
            return processExcelRows(headers, rows, sheetName);
        }

        function completeImport(data, sourceInfo) {
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error('Nenhum produto v√°lido encontrado na planilha');
            }

            allProductsData = data.map(function(product) {
                return ensureProductHistoryStructure(product);
            });
            debugLog(`Dados importados: ${data.length} produtos`);

            localStorage.setItem('stockData', JSON.stringify(allProductsData));
            localStorage.setItem('stockDataTimestamp', Date.now().toString());

            const descriptor = sourceInfo && sourceInfo.label ? sourceInfo.label : 'dados importados';
            activeImportDescriptor = descriptor;
            lastImportedFileName = sourceInfo && sourceInfo.fileName ? sourceInfo.fileName : '';
            lastImportedSheetName = sourceInfo && sourceInfo.sheetName ? sourceInfo.sheetName : '';

            const sheetSummary = sourceInfo && sourceInfo.sheetName
                ? ` Abas: ${sourceInfo.sheetName}.`
                : '';
            showMessage(`‚úÖ Dados importados com sucesso! ${data.length} produtos carregados.${sheetSummary}`, 'success');

            if (fileSystemSupported && directoryHandle) {
                debugLog('Tentando salvamento autom√°tico ap√≥s importa√ß√£o');
                saveDataAutomatically().then(function(success) {
                    if (success) {
                        showMessage('‚ú® Arquivo data.js atualizado automaticamente!', 'success');
                    }
                }).catch(function(error) {
                    debugLog(`Erro no salvamento autom√°tico: ${error.message}`, 'error');
                    showMessage('‚ö†Ô∏è Dados importados, mas erro no salvamento autom√°tico. Use "üíæ Baixar data.js".', 'warning');
                });
            } else if (fileSystemSupported) {
                showMessage('üí° Dica: Clique em "Configurar Pasta" para ativar salvamento autom√°tico!', 'info');
            }

            initializeDashboard();
        }

        function importData() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                showMessage('‚ùå Por favor, selecione um arquivo primeiro.', 'error');
                return;
            }

            debugLog(`Importando arquivo: ${file.name} (${file.size} bytes)`);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileName = file.name.toLowerCase();

                    if (fileName.endsWith('.csv')) {
                        const rawProducts = processCSV(e.target.result);
                        const finalizedProducts = finalizeProductList(rawProducts, 'Arquivo CSV');
                        completeImport(finalizedProducts, {
                            label: file.name,
                            fileName: file.name,
                            sheetName: 'Arquivo CSV'
                        });
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const sheetNames = workbook.SheetNames || [];

                        if (sheetNames.length === 0) {
                            throw new Error('A planilha n√£o cont√©m abas dispon√≠veis.');
                        }

                        const { combinedData, processedSheets } = mergeWorkbookData(workbook, sheetNames);

                        if (processedSheets.length === 0 || combinedData.length === 0) {
                            throw new Error('Nenhum dado v√°lido encontrado nas abas da planilha.');
                        }

                        const label = processedSheets.length === 1
                            ? `${file.name} ¬∑ ${processedSheets[0].name}`
                            : `${file.name} ¬∑ ${processedSheets.length} abas`;
                        const sheetSummary = processedSheets.map(function(info) {
                            return `${info.name} (${info.count})`;
                        }).join(', ');

                        completeImport(combinedData, {
                            label,
                            fileName: file.name,
                            sheetName: sheetSummary
                        });
                    } else {
                        throw new Error('Formato de arquivo n√£o suportado');
                    }
                } catch (error) {
                    debugLog(`Erro ao processar arquivo: ${error.message}`, 'error');
                    showMessage(`‚ùå Erro ao processar arquivo: ${error.message}`, 'error');
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function openTemplateGenerator() {
            try {
                window.open('gerador_template.html', '_blank');
            } catch (error) {
                debugLog(`Erro ao abrir gerador de template: ${error.message}`, 'error');
                showMessage('‚ùå Erro ao abrir gerador de template', 'error');
            }
        }

        function runDiagnostic() {
            debugLog('=== EXECUTANDO DIAGN√ìSTICO COMPLETO ===');
            console.clear();
            
            const report = [];
            report.push('üîç DIAGN√ìSTICO COMPLETO DO DASHBOARD v1.3');
            report.push('==========================================');
            
            // 1. Verificar dados
            report.push('\nüìä DADOS:');
            report.push(`- window.stockData existe: ${typeof window.stockData !== 'undefined'}`);
            report.push(`- √â array: ${Array.isArray(window.stockData)}`);
            report.push(`- Quantidade: ${window.stockData ? window.stockData.length : 0}`);
            report.push(`- allProductsData: ${allProductsData ? allProductsData.length : 'undefined'}`);
            
            // 2. Verificar elementos DOM
            report.push('\nüéØ ELEMENTOS DOM:');
            const elementos = ['importContent', 'toggleIcon', 'browserModeIndicator', 'autoSaveBtn', 'testBtn', 'lastUpdateInfo', 'excelFile', 'mappingDebug'];
            elementos.forEach(function(id) {
                const el = document.getElementById(id);
                const exists = !!el;
                const visible = el ? el.offsetHeight > 0 : false;
                report.push(`- ${id}: ${exists ? '‚úÖ' : '‚ùå'} ${exists ? (visible ? '(vis√≠vel)' : '(oculto)') : ''}`);
            });
            
            // 3. Verificar capacidades do navegador
            report.push('\nüåê NAVEGADOR:');
            report.push(`- UserAgent: ${navigator.userAgent}`);
            report.push(`- Protocolo: ${location.protocol}`);
            report.push(`- Hostname: ${location.hostname}`);
            report.push(`- URL completa: ${location.href}`);
            report.push(`- showDirectoryPicker: ${'showDirectoryPicker' in window ? '‚úÖ' : '‚ùå'}`);
            report.push(`- fileSystemSupported: ${fileSystemSupported ? '‚úÖ' : '‚ùå'}`);
            report.push(`- directoryHandle: ${directoryHandle ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}`);
            
            // 4. Verificar localStorage
            report.push('\nüíæ ARMAZENAMENTO LOCAL:');
            const storedData = localStorage.getItem('stockData');
            const storedTimestamp = localStorage.getItem('stockDataTimestamp');
            report.push(`- Dados salvos: ${storedData ? 'Sim' : 'N√£o'}`);
            report.push(`- Timestamp: ${storedTimestamp ? new Date(parseInt(storedTimestamp)).toLocaleString('pt-BR') : 'N√£o'}`);
            
            // 5. Verificar mapeamento (novo)
            report.push('\nüìã MAPEAMENTO:');
            if (lastMappingInfo) {
                report.push('- √öltimo mapeamento executado: ‚úÖ');
                report.push(`- Colunas detectadas: ${lastMappingInfo.headers.length}`);
                report.push(`- Avisos de mapeamento: ${lastMappingInfo.warnings.length}`);
                if (lastMappingInfo.warnings.length > 0) {
                    lastMappingInfo.warnings.forEach(warning => {
                        report.push(`  ‚ö†Ô∏è ${warning}`);
                    });
                }
            } else {
                report.push('- Nenhum mapeamento executado ainda');
            }
            
            // 6. Verificar funcionalidades
            report.push('\n‚öôÔ∏è FUNCIONALIDADES:');
            report.push(`- Import section expanded: ${document.getElementById('importContent')?.classList.contains('expanded') ? 'Sim' : 'N√£o'}`);
            report.push(`- Debug mode: ${debugMode ? 'Ativo' : 'Inativo'}`);
            report.push(`- Mapping debug mode: ${mappingDebugMode ? 'Ativo' : 'Inativo'}`);
            
            if (location.protocol === 'file:') {
                report.push('\nüöÄ INSTRU√á√ïES PARA SALVAMENTO AUTOM√ÅTICO:');
                report.push('Voc√™ est√° usando protocolo file://, que n√£o suporta File System API.');
                report.push('Para ativar salvamento autom√°tico, use um servidor web local:');
                report.push('');
                report.push('M√âTODO 1 - Python (j√° instalado no Windows):');
                report.push('1. Abra o Prompt de Comando na pasta do projeto');
                report.push('2. Execute: python -m http.server 8000');
                report.push('3. Acesse: http://localhost:8000');
                report.push('');
                report.push('M√âTODO 2 - Live Server (VS Code):');
                report.push('1. Instale a extens√£o "Live Server" no VS Code');
                report.push('2. Clique direito no index.html ‚Üí "Open with Live Server"');
                report.push('3. Acesse: http://localhost:5500');
            }
            
            report.push('\nüéØ DIAGN√ìSTICO CONCLU√çDO!');
            
            // Mostrar relat√≥rio
            const fullReport = report.join('\n');
            console.log(fullReport);
            
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                if (debugDiv) {
                    debugDiv.innerHTML = '<pre>' + fullReport + '</pre>';
                }
            }
            
            showMessage('üîç Diagn√≥stico executado! Verifique o console (F12) para detalhes completos.', 'info');
        }

        function toggleImportSection() {
            const content = document.getElementById('importContent');
            const icon = document.getElementById('toggleIcon');
            
            if (!content || !icon) {
                debugLog('Elementos de importa√ß√£o n√£o encontrados', 'error');
                return;
            }
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.textContent = '‚ñº';
                debugLog('Se√ß√£o de importa√ß√£o fechada');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');  
                icon.textContent = '‚ñ≤';
                debugLog('Se√ß√£o de importa√ß√£o aberta');
            }
        }

        function downloadDataFile() {
            if (allProductsData.length === 0) {
                showMessage('‚ùå Nenhum dado para salvar. Importe uma planilha primeiro.', 'error');
                return;
            }

            const dataContent = saveDataToFile(allProductsData);
            const blob = new Blob([dataContent], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('üíæ Arquivo data.js baixado! Substitua o arquivo na pasta compartilhada.', 'success');
            debugLog('Arquivo data.js baixado via download manual');
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('importMessages');
            const messageClass = {
                'success': 'success-message',
                'error': 'error-message',
                'warning': 'warning-message',
                'info': 'info-message'
            }[type] || 'info-message';
            
            messagesDiv.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            setTimeout(function() {
                messagesDiv.innerHTML = '';
            }, 8000);
        }

        // === FUN√á√ïES DE BUSCA E FILTROS ===
        function performGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                document.getElementById('searchResults').innerHTML = '';
                applyAllFilters();
                removeHighlights();
                return;
            }

            resetAllFilters();

            const searchResults = allProductsData.filter(function(product) {
                return product.code.toLowerCase().includes(searchTerm) ||
                    product.item.toLowerCase().includes(searchTerm) ||
                    product.supplier.toLowerCase().includes(searchTerm) ||
                    product.family.toLowerCase().includes(searchTerm);
            });

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `üîç <strong>${searchResults.length}</strong> produtos encontrados para: "<em>${searchTerm}</em>"`;

            applyAllFilters();
            highlightSearchResults();
        }

        function resetAllFilters() {
            currentFilter = 'all';
            predictionFilter = null;
            selectedFamily = null;
            selectedSupplier = null;
            currentEstablishment = '';
            criticalFilterActive = false;
            advancedStockFilter = '';

            document.getElementById('familyFilter').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('establishmentFilter').value = '';
            const advancedDropdown = document.getElementById('advancedStockFilter');
            if (advancedDropdown) {
                advancedDropdown.value = '';
            }

            updateActiveButton('all');
            
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
        }

        function clearSearch() {
            resetAllFilters();
            document.getElementById('globalSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            searchTerm = '';
            applyAllFilters();
            removeHighlights();
        }

        function highlightSearchResults() {
            const gaugeCards = document.querySelectorAll('.gauge-card');
            gaugeCards.forEach(function(card) {
                const title = card.querySelector('.gauge-title').textContent.toLowerCase();
                if (searchTerm && title.includes(searchTerm)) {
                    card.classList.add('highlighted');
                } else {
                    card.classList.remove('highlighted');
                }
            });

            const tableRows = document.querySelectorAll('#productsTableBody tr');
            tableRows.forEach(function(row) {
                const rowText = row.textContent.toLowerCase();
                if (searchTerm && rowText.includes(searchTerm)) {
                    row.classList.add('highlighted');
                    row.classList.add('highlight-animation');
                } else {
                    row.classList.remove('highlighted');
                }
            });
        }

        function removeHighlights() {
            const highlighted = document.querySelectorAll('.highlighted');
            highlighted.forEach(function(el) {
                el.classList.remove('highlighted');
            });
            const animations = document.querySelectorAll('.highlight-animation');
            animations.forEach(function(el) {
                el.classList.remove('highlight-animation');
            });
        }

        // === FUN√á√ïES DE DADOS - VERS√ÉO CORRIGIDA ===
        function processCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(function(h) {
                return h.trim().replace(/"/g, '');
            });
            const mapping = findColumnMapping(headers);
            const products = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parseCSVLine(line);
                if (values.length === 0) continue;

                while (values.length < headers.length) {
                    values.push('');
                }

                const product = mapProductData(headers, values, 'Arquivo CSV', mapping);
                if (product.code) {
                    products.push(product);
                }
            }

            return products;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function processExcelRows(headers, rows, sheetName) {
            const products = [];
            const mapping = findColumnMapping(headers);

            rows.forEach(function(row) {
                if (!Array.isArray(row)) {
                    return;
                }

                const hasContent = row.some(function(cell) {
                    return hasMeaningfulValue(cell);
                });

                if (!hasContent) {
                    return;
                }

                const values = headers.map(function(_, index) {
                    return typeof row[index] !== 'undefined' ? row[index] : '';
                });

                const product = mapProductData(headers, values, sheetName, mapping);
                if (product.code) {
                    products.push(product);
                }
            });

            return products;
        }

        function mapProductData(headers, values, sheetName, mapping) {
            const columnMapping = mapping || findColumnMapping(headers);

            const rawStockMonthsCell = columnMapping.stockMonths !== undefined ? values[columnMapping.stockMonths] : null;
            const rawCoberturaCell = columnMapping.cobertura !== undefined ? values[columnMapping.cobertura] : null;

            const parsedStockMonths = parseNumber(rawStockMonthsCell);
            const parsedCobertura = parseNumber(rawCoberturaCell);

            const hasStockMonths = hasMeaningfulValue(rawStockMonthsCell);
            const hasCobertura = hasMeaningfulValue(rawCoberturaCell);
            const validStockMonths = hasStockMonths && Number.isFinite(parsedStockMonths);
            const validCobertura = hasCobertura && Number.isFinite(parsedCobertura);

            let effectiveCoverage = 0;
            let coverageSource = 'none';

            if (validStockMonths) {
                effectiveCoverage = parsedStockMonths;
                coverageSource = 'stockMonths';
            } else if (validCobertura) {
                effectiveCoverage = parsedCobertura;
                coverageSource = 'cobertura';
            }

            const product = {
                code: sanitizeText(values[columnMapping.code] || ''),
                supplier: sanitizeText(values[columnMapping.supplier] || ''),
                family: sanitizeText(values[columnMapping.family] || ''),
                item: sanitizeText(values[columnMapping.item] || ''),
                stock14: parseNumber(values[columnMapping.stock14] || 0),
                stock9013: parseNumber(values[columnMapping.stock9013] || 0),
                stock9015: parseNumber(values[columnMapping.stock9015] || 0),
                vendas4M: parseNumber(values[columnMapping.vendas4M] || 0),
                media3M: parseNumber(values[columnMapping.media3M]) || 0,
                novembro: parseNumber(values[columnMapping.novembro]) || 0,
                dezembro: parseNumber(values[columnMapping.dezembro]) || 0,
                cobertura: validCobertura ? parsedCobertura : null
            };

            product.stockMonths = Number.isFinite(effectiveCoverage) ? effectiveCoverage : 0;
            product.coverageSource = coverageSource;
            product.originSheet = sheetName || '';

            const monthlyValues = [];
            headers.forEach(function(header, index) {
                if (!header || !isMonthHeader(header)) {
                    return;
                }

                const rawValue = values[index];
                if (!hasMeaningfulValue(rawValue)) {
                    return;
                }

                const numericValue = parseNumber(rawValue);
                monthlyValues.push({
                    label: header.toString().trim(),
                    value: Number.isFinite(numericValue) ? numericValue : 0,
                    rawValue: rawValue
                });
            });

            product.sheetMonthlyValues = sortMonthlyValues(monthlyValues);

            return product;
        }

        function mergeProductIntoMap(map, product, sheetName) {
            if (!product || !product.code) {
                return;
            }

            const monthlyValues = cloneMonthlyValues(product.sheetMonthlyValues);
            const historyEntry = createHistoryEntry(product, sheetName || product.originSheet || '');

            if (!map.has(product.code)) {
                const newProduct = Object.assign({}, product);
                newProduct.monthlyValues = aggregateMonthlyValues([], monthlyValues);
                newProduct.importHistory = [historyEntry];
                newProduct.latestSheet = sheetName || product.originSheet || '';
                delete newProduct.sheetMonthlyValues;
                delete newProduct.originSheet;
                map.set(product.code, newProduct);
                return;
            }

            const existing = map.get(product.code);
            existing.importHistory = Array.isArray(existing.importHistory) ? existing.importHistory : [];
            existing.importHistory.push(historyEntry);
            existing.latestSheet = sheetName || existing.latestSheet || '';

            existing.monthlyValues = aggregateMonthlyValues(existing.monthlyValues || [], monthlyValues);

            existing.supplier = product.supplier || existing.supplier;
            existing.family = product.family || existing.family;
            existing.item = product.item || existing.item;
            existing.stock14 = product.stock14;
            existing.stock9013 = product.stock9013;
            existing.stock9015 = product.stock9015;
            existing.stockMonths = product.stockMonths;
            existing.vendas4M = product.vendas4M;
            existing.media3M = product.media3M;
            existing.novembro = product.novembro;
            existing.dezembro = product.dezembro;
            existing.cobertura = product.cobertura;
            existing.coverageSource = product.coverageSource;

            delete existing.sheetMonthlyValues;
            delete existing.originSheet;
        }

        function finalizeProductList(products, sheetName) {
            const productMap = new Map();
            (Array.isArray(products) ? products : []).forEach(function(product) {
                mergeProductIntoMap(productMap, product, sheetName || product.originSheet || '');
            });
            return Array.from(productMap.values()).sort(function(a, b) {
                return a.code.localeCompare(b.code, 'pt-BR', { sensitivity: 'base', numeric: true });
            });
        }

        function mergeWorkbookData(workbook, sheetNames) {
            const productMap = new Map();
            const processedSheets = [];

            sheetNames.forEach(function(sheetName) {
                try {
                    const sheetData = extractWorkbookData(workbook, sheetName);
                    if (!Array.isArray(sheetData) || sheetData.length === 0) {
                        debugLog(`Aba "${sheetName}" sem dados relevantes ou vazia.`, 'warn');
                        return;
                    }

                    sheetData.forEach(function(product) {
                        mergeProductIntoMap(productMap, product, sheetName);
                    });

                    processedSheets.push({
                        name: sheetName,
                        count: sheetData.length
                    });
                } catch (error) {
                    debugLog(`Erro ao processar aba "${sheetName}": ${error.message}`, 'error');
                }
            });

            const combinedData = Array.from(productMap.values()).sort(function(a, b) {
                return a.code.localeCompare(b.code, 'pt-BR', { sensitivity: 'base', numeric: true });
            });

            return { combinedData, processedSheets };
        }

        // FUN√á√ÉO ATUALIZADA v1.3.0 - Mapeamento Espec√≠fico para sua Planilha
        function findColumnMapping(headers) {
            debugLog('=== MAPEAMENTO v1.3.0 - AN√ÅLISE ESPEC√çFICA ===');
            debugLog(`Colunas encontradas: ${headers.length}`);

            headers.forEach(function(h, index) {
                debugLog(`[${index}] "${h}"`);
            });

            const upperHeaders = headers.map(function(header) {
                return (header || '').toString().toUpperCase().trim();
            });
            const normalizedHeaders = headers.map(function(header) {
                return (header || '')
                    .toString()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, '');
            });

            const mapping = {};
            const warnings = [];
            const headerCount = headers.length;

            function assignField(field, index, detail) {
                if (typeof index === 'number' && index >= 0) {
                    mapping[field] = index;
                    const label = headers[index] || '';
                    const suffix = detail ? ` ${detail}` : '';
                    debugLog(`‚úÖ ${field} ‚Üí [${index}] "${label}"${suffix}`);
                }
            }

            function findIndex(predicate) {
                for (let i = 0; i < headerCount; i++) {
                    if (predicate(i, upperHeaders[i], normalizedHeaders[i])) {
                        return i;
                    }
                }
                return undefined;
            }

            assignField('code', findIndex(function(_, upper) {
                return upper === 'C√ìDIGO' || upper === 'CODIGO' || upper === 'CODE';
            }));

            assignField('supplier', findIndex(function(_, upper) {
                return upper === 'FORNECEDOR' || upper === 'SUPPLIER';
            }));

            assignField('family', findIndex(function(_, upper) {
                return upper === 'FAM√çLIA' || upper === 'FAMILIA' || upper === 'FAMILY';
            }));

            assignField('item', findIndex(function(_, upper) {
                return upper === 'ITEM' || upper === 'PRODUTO' || upper === 'PRODUCT';
            }));

            for (let i = 0; i < headerCount; i++) {
                const upper = upperHeaders[i];
                if (mapping.stock14 === undefined && (upper === '1-4' || upper === '1_4' || upper.includes('1-4'))) {
                    assignField('stock14', i);
                } else if (mapping.stock9013 === undefined && (upper === '90-13' || upper === '90_13' || upper.includes('90-13'))) {
                    assignField('stock9013', i);
                } else if (mapping.stock9015 === undefined && (upper === '90-15' || upper === '90_15' || upper.includes('90-15'))) {
                    assignField('stock9015', i);
                }
            }

            assignField('stockMonths', findIndex(function(_, upper, normalized) {
                return (upper.includes('ESTOQUE') && upper.includes('MESES')) || normalized.includes('STOCKMONTHS');
            }));

            assignField('cobertura', findIndex(function(_, __, normalized) {
                return normalized.includes('COBERTURA') || normalized.includes('COVERAGE');
            }));

            let vendasIndex = findIndex(function(_, __, normalized) {
                return normalized.includes('VENDAS4');
            });
            if (typeof vendasIndex === 'number') {
                assignField('vendas4M', vendasIndex);
            } else {
                vendasIndex = findIndex(function(_, __, normalized) {
                    return normalized.includes('VENDAS3');
                });
                if (typeof vendasIndex === 'number') {
                    assignField('vendas4M', vendasIndex, '(usando VENDAS 3M)');
                    warnings.push('Coluna VENDAS 4M n√£o encontrada; utilizando VENDAS 3M da planilha.');
                }
            }

            assignField('media3M', findIndex(function(_, __, normalized) {
                return normalized.includes('MEDIA3');
            }));

            const novembroIndex = findIndex(function(_, __, normalized) {
                return normalized.includes('NOVEMBRO');
            });
            if (typeof novembroIndex === 'number') {
                assignField('novembro', novembroIndex);
            } else {
                warnings.push('Coluna NOVEMBRO n√£o encontrada na planilha.');
                debugLog('‚ö†Ô∏è Coluna NOVEMBRO n√£o identificada nos cabe√ßalhos recebidos.');
            }

            const dezembroIndex = findIndex(function(_, __, normalized) {
                return normalized.includes('DEZEMBRO');
            });
            if (typeof dezembroIndex === 'number') {
                assignField('dezembro', dezembroIndex);
            } else {
                warnings.push('Coluna DEZEMBRO n√£o encontrada na planilha.');
                debugLog('‚ö†Ô∏è Coluna DEZEMBRO n√£o identificada nos cabe√ßalhos recebidos.');
            }

            if (mapping.stockMonths === undefined && mapping.cobertura !== undefined) {
                mapping.stockMonths = mapping.cobertura;
                warnings.push('Coluna ESTOQUE EM MESES n√£o encontrada; usando COBERTURA da planilha.');
                debugLog('üîÑ stockMonths ‚Üí cobertura (fallback)');
            }

            if (mapping.cobertura === undefined && mapping.stockMonths !== undefined) {
                mapping.cobertura = mapping.stockMonths;
                warnings.push('Coluna COBERTURA n√£o encontrada; usando ESTOQUE EM MESES como refer√™ncia.');
                debugLog('üîÑ cobertura ‚Üí stockMonths (fallback)');
            }

            if (mapping.stock9015 === undefined) {
                warnings.push('CR√çTICO: Coluna 90-15 N√ÉO ENCONTRADA!');
                debugLog('üö® CR√çTICO: Coluna 90-15 N√ÉO ENCONTRADA na planilha!');
            } else {
                const mappedHeader = headers[mapping.stock9015];
                if (mappedHeader !== '90-15' && mappedHeader !== '90_15') {
                    warnings.push(`ATEN√á√ÉO: stock9015 mapeado para "${mappedHeader}" em vez de "90-15"`);
                    debugLog(`‚ö†Ô∏è stock9015 mapeado para "${mappedHeader}" - pode estar incorreto`);
                }
            }

            debugLog('=== MAPEAMENTO FINAL v1.3.0 ===');
            Object.entries(mapping).forEach(function([field, index]) {
                const header = headers[index] || 'INV√ÅLIDO';
                debugLog(`${field.padEnd(12)} ‚Üí [${index}] "${header}"`);
            });

            const requiredFields = {
                code: 'C√ìDIGO',
                supplier: 'FORNECEDOR',
                family: 'FAM√çLIA',
                item: 'ITEM',
                stock14: '1-4',
                stock9013: '90-13',
                stock9015: '90-15',
                vendas4M: 'VENDAS 4M',
                media3M: 'M√âDIA 3M',
                stockMonths: 'ESTOQUE EM MESES/COBERTURA'
            };

            const missingFields = Object.keys(requiredFields).filter(function(field) {
                return typeof mapping[field] !== 'number';
            });

            lastMappingInfo = {
                headers: headers.slice(),
                mapping: Object.assign({}, mapping),
                warnings: warnings.slice(),
                version: '1.3.0'
            };

            debugLog(`=== MAPEAMENTO v1.3.0 CONCLU√çDO - ${warnings.length} avisos ===`);
            warnings.forEach(function(warning) {
                debugLog(`‚ö†Ô∏è ${warning}`);
            });

            if (missingFields.length > 0) {
                const labels = missingFields.map(function(field) { return requiredFields[field]; });
                const error = new Error(`N√£o foi poss√≠vel identificar as colunas obrigat√≥rias: ${labels.join(', ')}`);
                error.missingFields = labels;
                error.mappingInfo = lastMappingInfo;
                throw error;
            }

            if (mappingDebugMode) {
                showMappingInfo(lastMappingInfo);
            }

            return mapping;
        }

        function sanitizeText(text) {
            if (!text) return '';
            return text.toString().trim().replace(/"/g, '');
        }

        function parseNumber(value) {
            if (value === null || typeof value === 'undefined') {
                return 0;
            }

            const stringValue = value.toString().trim();
            if (stringValue === '') {
                return 0;
            }

            const sanitized = stringValue.replace(/\s+/g, '');
            const digitsOnly = sanitized.replace(/[^0-9.,-]/g, '');
            if (digitsOnly === '' || digitsOnly === '-' || digitsOnly === ',' || digitsOnly === '.') {
                return 0;
            }

            const hasComma = digitsOnly.includes(',');
            const hasDot = digitsOnly.includes('.');
            let normalized = digitsOnly;

            const brazilianThousandPattern = /^-?\d{1,3}(\.\d{3})+(,\d+)?$/;
            const americanThousandPattern = /^-?\d{1,3}(,\d{3})+(\.\d+)?$/;

            if (brazilianThousandPattern.test(digitsOnly)) {
                normalized = digitsOnly.replace(/\./g, '').replace(',', '.');
            } else if (americanThousandPattern.test(digitsOnly)) {
                normalized = digitsOnly.replace(/,/g, '');
            } else if (hasComma && hasDot) {
                if (digitsOnly.lastIndexOf(',') > digitsOnly.lastIndexOf('.')) {
                    normalized = digitsOnly.replace(/\./g, '').replace(',', '.');
                } else {
                    normalized = digitsOnly.replace(/,/g, '');
                }
            } else if (hasComma) {
                normalized = digitsOnly.replace(/\./g, '').replace(',', '.');
            } else if (hasDot) {
                const dotCount = (digitsOnly.match(/\./g) || []).length;
                if (dotCount > 1) {
                    normalized = digitsOnly.replace(/\./g, '');
                } else {
                    const decimalPart = digitsOnly.split('.')[1] || '';
                    if (decimalPart.length === 3 && digitsOnly.length > 4) {
                        normalized = digitsOnly.replace(/\./g, '');
                    }
                }
            }

            const parsed = parseFloat(normalized);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        // === FUN√á√ïES DE FILTROS ===
        function resetOver50AdvancedFilter() {
            if (advancedStockFilter === 'over50') {
                advancedStockFilter = '';
                const advancedDropdown = document.getElementById('advancedStockFilter');
                if (advancedDropdown) {
                    advancedDropdown.value = '';
                }
            }
        }

        function populateFamilyFilter() {
            const families = [...new Set(allProductsData.map(function(p) {
                return p.family;
            }))].sort();
            const select = document.getElementById('familyFilter');
            select.innerHTML = '<option value="">Todas as Fam√≠lias</option>';
            families.forEach(function(family) {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                select.appendChild(option);
            });
        }

        function populateSupplierFilter() {
            const suppliers = [...new Set(allProductsData.map(function(p) {
                return p.supplier;
            }))].sort();
            const select = document.getElementById('supplierFilter');
            select.innerHTML = '<option value="">Todos os Fornecedores</option>';
            suppliers.forEach(function(supplier) {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                select.appendChild(option);
            });
        }

        function showAllProducts() {
            currentFilter = 'all';
            predictionFilter = null;
            selectedFamily = null;
            selectedSupplier = null;
            criticalFilterActive = false;
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
            document.getElementById('familyFilter').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('establishmentFilter').value = '';
            document.getElementById('advancedStockFilter').value = '';
            advancedStockFilter = '';
            updateActiveButton('all');
            applyAllFilters();
        }

        function filterCriticalStock() {
            if (criticalFilterActive) {
                criticalFilterActive = false;
                currentFilter = 'all';
                updateActiveButton('all');
                applyAllFilters();
            } else {
                criticalFilterActive = true;
                currentFilter = 'critical';
                predictionFilter = null;
                resetOver50AdvancedFilter();
                const activeItems = document.querySelectorAll('.prediction-item.active');
                activeItems.forEach(function(item) {
                    item.classList.remove('active');
                });
                updateActiveButton('critical');
                applyAllFilters();
            }
        }

        function filterLowStock() {
            currentFilter = 'low';
            predictionFilter = null;
            criticalFilterActive = false;
            resetOver50AdvancedFilter();
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
            updateActiveButton('low');
            applyAllFilters();
        }

        function filterHighStock() {
            currentFilter = 'high';
            predictionFilter = null;
            criticalFilterActive = false;
            resetOver50AdvancedFilter();
            const activeItems = document.querySelectorAll('.prediction-item.active');
            activeItems.forEach(function(item) {
                item.classList.remove('active');
            });
            updateActiveButton('high');
            applyAllFilters();
        }

        function filterByFamily() {
            const familyDropdown = document.getElementById('familyFilter');
            selectedFamily = familyDropdown.value;
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterBySupplier() {
            const supplierDropdown = document.getElementById('supplierFilter');
            selectedSupplier = supplierDropdown.value;
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterByEstablishment() {
            currentEstablishment = document.getElementById('establishmentFilter').value;
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterByAdvancedStock() {
            const advancedDropdown = document.getElementById('advancedStockFilter');
            advancedStockFilter = advancedDropdown ? advancedDropdown.value : '';
            criticalFilterActive = false;
            applyAllFilters();
        }

        function filterByGauge(family) {
            if (selectedFamily === family) {
                selectedFamily = null;
                document.getElementById('familyFilter').value = '';
                showAllProducts();
            } else {
                selectedFamily = family;
                document.getElementById('familyFilter').value = family;
                filterByFamily();
            }
        }

        function filterZeroIn30() {
            const item30 = document.querySelector('.prediction-item.clickable[onclick="filterZeroIn30()"]');
            
            if (predictionFilter === 'zero30') {
                predictionFilter = null;
                item30.classList.remove('active');
                showAllProducts();
            } else {
                const activeItems = document.querySelectorAll('.prediction-item.active');
                activeItems.forEach(function(item) {
                    item.classList.remove('active');
                });
                
                predictionFilter = 'zero30';
                criticalFilterActive = false;
                item30.classList.add('active');
                currentFilter = 'prediction30';
                updateActiveButton(null);
                
                applyAllFilters();
            }
        }

        function filterZeroIn60() {
            const item60 = document.querySelector('.prediction-item.clickable[onclick="filterZeroIn60()"]');

            if (predictionFilter === 'zero60') {
                predictionFilter = null;
                item60.classList.remove('active');
                showAllProducts();
            } else {
                const activeItems = document.querySelectorAll('.prediction-item.active');
                activeItems.forEach(function(item) {
                    item.classList.remove('active');
                });

                predictionFilter = 'zero60';
                criticalFilterActive = false;
                item60.classList.add('active');
                currentFilter = 'prediction60';
                updateActiveButton(null);

                applyAllFilters();
            }
        }

        function assignAbcClassification(dataSet) {
            const classificationMap = new Map();

            if (!Array.isArray(dataSet) || dataSet.length === 0) {
                abcClassificationMap = classificationMap;
                if (Array.isArray(dataSet)) {
                    dataSet.forEach(function(product) {
                        product.currentAbcClass = '‚Äî';
                        product.individualSalesShare = 0;
                        product.cumulativeSalesShare = 0;
                    });
                }
                return classificationMap;
            }

            const sortedData = dataSet.slice().sort(function(a, b) {
                return (b.vendas4M || 0) - (a.vendas4M || 0);
            });

            const totalSales = sortedData.reduce(function(sum, product) {
                const sales = Math.max(product.vendas4M || 0, 0);
                return sales > 0 ? sum + sales : sum;
            }, 0);

            if (totalSales === 0) {
                sortedData.forEach(function(product) {
                    classificationMap.set(product.code, '‚Äî');
                    product.currentAbcClass = '‚Äî';
                    product.individualSalesShare = 0;
                    product.cumulativeSalesShare = 0;
                });
                abcClassificationMap = classificationMap;
                return classificationMap;
            }

            let hasClassA = false;
            let hasClassB = false;

            sortedData.forEach(function(product) {
                const sales = Math.max(product.vendas4M || 0, 0);
                const individualShare = totalSales === 0 ? 0 : sales / totalSales;
                product.individualSalesShare = individualShare;
                product.cumulativeSalesShare = individualShare;

                let classification = 'C';
                if (individualShare >= abcIndividualThresholds.classA) {
                    classification = 'A';
                    hasClassA = true;
                } else if (individualShare >= abcIndividualThresholds.classB) {
                    classification = 'B';
                    hasClassB = true;
                }

                classificationMap.set(product.code, classification);
            });

            if (!hasClassA && sortedData.length > 0) {
                const topProduct = sortedData[0];
                classificationMap.set(topProduct.code, 'A');
            }

            if (!hasClassB && sortedData.length > 1) {
                let candidate = sortedData.find(function(product) {
                    return classificationMap.get(product.code) !== 'A' && (product.vendas4M || 0) > 0;
                });
                if (!candidate) {
                    candidate = sortedData.find(function(product) {
                        return classificationMap.get(product.code) !== 'A';
                    });
                }
                if (candidate) {
                    classificationMap.set(candidate.code, 'B');
                }
            }

            dataSet.forEach(function(product) {
                const classification = classificationMap.get(product.code) || '‚Äî';
                product.currentAbcClass = classification;
                if (!classificationMap.has(product.code)) {
                    classificationMap.set(product.code, classification);
                }
            });

            abcClassificationMap = classificationMap;
            return classificationMap;
        }

        function applyAllFilters() {
            let baseData = allProductsData.slice();
            const { urgentDays, warningDays } = getPredictionSettings();

            if (predictionFilter === 'zero30') {
                baseData = baseData.filter(function(p) {
                    const coverage = getCoverageInfo(p);
                    if (coverage.outOfStock) {
                        return true;
                    }
                    if (coverage.daysToDepletion === null) {
                        return false;
                    }
                    return coverage.daysToDepletion <= urgentDays;
                });
            } else if (predictionFilter === 'zero60') {
                baseData = baseData.filter(function(p) {
                    const coverage = getCoverageInfo(p);
                    if (coverage.outOfStock) {
                        return false;
                    }
                    if (coverage.daysToDepletion === null) {
                        return false;
                    }
                    return coverage.daysToDepletion > urgentDays && coverage.daysToDepletion <= warningDays;
                });
            }

            if (searchTerm) {
                baseData = baseData.filter(function(product) {
                    return product.code.toLowerCase().includes(searchTerm) ||
                        product.item.toLowerCase().includes(searchTerm) ||
                        product.supplier.toLowerCase().includes(searchTerm) ||
                        product.family.toLowerCase().includes(searchTerm);
                });
            }

            if (!predictionFilter) {
                switch(currentFilter) {
                    case 'critical':
                        baseData = baseData.filter(function(p) {
                            return p.stockMonths < 2;
                        });
                        break;
                    case 'low':
                        baseData = baseData.filter(function(p) {
                            return p.stockMonths >= 2 && p.stockMonths < 6;
                        });
                        break;
                    case 'high':
                        baseData = baseData.filter(function(p) {
                            return p.stockMonths >= 6;
                        });
                        break;
                }
            }

            if (selectedFamily) {
                baseData = baseData.filter(function(product) {
                    return product.family === selectedFamily;
                });
            }

            if (selectedSupplier) {
                baseData = baseData.filter(function(product) {
                    return product.supplier === selectedSupplier;
                });
            }

            if (currentEstablishment) {
                baseData = baseData.filter(function(product) {
                    const stock = getProductStock(product);
                    if (advancedStockFilter === 'no-stock') {
                        return stock <= 0;
                    }
                    return stock > 0;
                });
            }

            assignAbcClassification(baseData);

            if (advancedStockFilter && advancedStockFilter.startsWith('abc-')) {
                const desiredClass = advancedStockFilter.slice(4).toUpperCase();
                baseData = baseData.filter(function(product) {
                    return (product.currentAbcClass || '‚Äî') === desiredClass;
                });
            } else if (advancedStockFilter === 'no-stock') {
                baseData = baseData.filter(function(product) {
                    return getProductStock(product) <= 0;
                });
            } else if (advancedStockFilter === 'over50') {
                baseData = baseData.filter(function(product) {
                    const coverage = getCoverageInfo(product);
                    if (coverage.daysToDepletion !== null) {
                        return (coverage.daysToDepletion / 30) > 50;
                    }
                    return product.stockMonths > 50;
                });
            }

            filteredData = baseData;
            updateParetoAnalysis();
            updateTable();
            updateSummary();
            updateGauges();
            updatePredictiveAnalysis();
        }

        function updateActiveButton(filter) {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(function(btn) {
                btn.classList.remove('active');
                if (filter && btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
        }

        // === FUN√á√ïES DE AN√ÅLISE ===
        function updatePredictiveAnalysis() {
            applyPredictionLabels();

            const { urgentDays, warningDays } = getPredictionSettings();
            let urgentCount = 0;
            let warningCount = 0;

            filteredData.forEach(function(product) {
                const coverage = getCoverageInfo(product);

                if (coverage.outOfStock) {
                    urgentCount++;
                    return;
                }

                if (coverage.daysToDepletion === null) {
                    return;
                }

                if (coverage.daysToDepletion <= urgentDays) {
                    urgentCount++;
                } else if (coverage.daysToDepletion <= warningDays) {
                    warningCount++;
                }
            });

            const zeroIn30Element = document.getElementById('zeroIn30');
            const zeroIn60Element = document.getElementById('zeroIn60');

            if (zeroIn30Element) {
                zeroIn30Element.textContent = urgentCount;
                zeroIn30Element.className = urgentCount > 0
                    ? 'prediction-value prediction-critical'
                    : 'prediction-value prediction-good';
            }

            if (zeroIn60Element) {
                zeroIn60Element.textContent = warningCount;
                zeroIn60Element.className = warningCount > 0
                    ? 'prediction-value prediction-warning'
                    : 'prediction-value prediction-good';
            }
        }
        function updateSummary() {
            const total = filteredData.length;
            const coverageValues = filteredData
                .map(function(p) {
                    const coverage = getCoverageValue(p);
                    return Number.isFinite(coverage) ? coverage : null;
                })
                .filter(function(value) { return value !== null; })
                .sort(function(a, b) { return a - b; });

            const totalCoverage = coverageValues.reduce(function(sum, value) {
                return sum + value;
            }, 0);

            const avgStock = coverageValues.length > 0 ? totalCoverage / coverageValues.length : 0;
            const criticalCount = filteredData.filter(function(p) {
                const coverage = getCoverageValue(p);
                return Number.isFinite(coverage) && coverage < 2;
            }).length;
            const families = new Set(filteredData.map(function(p) {
                return p.family;
            })).size;
            const totalStock = filteredData.reduce(function(sum, product) {
                return sum + getProductStock(product);
            }, 0);
            const safeTotalStock = Number.isFinite(totalStock) ? totalStock : 0;

            document.getElementById('totalProducts').textContent = total;
            document.getElementById('avgStockMonths').textContent = coverageValues.length > 0 ? formatStatValue(avgStock) : '--';
            document.getElementById('totalCoverage').textContent = coverageValues.length > 0 ? formatStatValue(totalCoverage) : '--';
            document.getElementById('totalStockValue').textContent = formatIntegerValue(safeTotalStock);
            document.getElementById('criticalCount').textContent = criticalCount;
            document.getElementById('totalFamilies').textContent = families;
        }

        function updateParetoAnalysis() {
            const container = document.getElementById('paretoContent');
            if (!container) {
                return;
            }

            if (!Array.isArray(filteredData) || filteredData.length === 0) {
                container.innerHTML = '<p class="pareto-empty">Nenhum produto para an√°lise.</p>';
                return;
            }

            const sortedData = filteredData.slice().sort(function(a, b) {
                return (b.vendas4M || 0) - (a.vendas4M || 0);
            });
            const totalSales = sortedData.reduce(function(sum, product) {
                const sales = Math.max(product.vendas4M || 0, 0);
                return sales > 0 ? sum + sales : sum;
            }, 0);

            if (totalSales === 0) {
                container.innerHTML = '<p class="pareto-empty">Sem dados de vendas para calcular a an√°lise ABC.</p>';
                return;
            }

            const displayLimit = 10;
            const rows = [];
            const normalizeShare = function(value) {
                if (!Number.isFinite(value)) {
                    return 0;
                }
                if (value < 0) {
                    return 0;
                }
                if (value > 1) {
                    return 1;
                }
                return value;
            };

            sortedData.forEach(function(product, index) {
                const sales = Math.max(product.vendas4M || 0, 0);
                const hasStoredShare = typeof product.individualSalesShare === 'number' && Number.isFinite(product.individualSalesShare);
                const fallbackShare = totalSales === 0 ? 0 : sales / totalSales;
                const individualShare = hasStoredShare
                    ? normalizeShare(product.individualSalesShare)
                    : normalizeShare(fallbackShare);

                if (!hasStoredShare) {
                    product.individualSalesShare = individualShare;
                }

                const rawClass = (typeof product.currentAbcClass === 'string' && product.currentAbcClass)
                    ? product.currentAbcClass.toUpperCase()
                    : '‚Äî';
                const isValidClass = rawClass === 'A' || rawClass === 'B' || rawClass === 'C';
                const classification = isValidClass ? rawClass : '‚Äî';
                const classificationCell = isValidClass
                    ? `<span class="abc-chip abc-${classification.toLowerCase()}">${classification}</span>`
                    : '‚Äî';

                if (index < displayLimit) {
                    rows.push(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product.code}</td>
                            <td>${product.item}</td>
                            <td>${(product.vendas4M || 0).toLocaleString()}</td>
                            <td>${(individualShare * 100).toFixed(1)}%</td>
                            <td>${classificationCell}</td>
                        </tr>
                    `);
                }
            });

            const tableHtml = `
                <table class="pareto-table">
                    <thead>
                        <tr>
                            <th><span class="header-label">#<span class="info-icon has-tooltip" tabindex="0" aria-label="Posi√ß√£o no ranking" data-tooltip="Lugar do produto na lista, indo do que mais vende para o que menos vende." data-tooltip-position="top">?</span></span></th>
                            <th><span class="header-label">C√≥digo<span class="info-icon has-tooltip" tabindex="0" aria-label="C√≥digo do produto" data-tooltip="N√∫mero usado no sistema para identificar o produto." data-tooltip-position="top">?</span></span></th>
                            <th><span class="header-label">Item<span class="info-icon has-tooltip" tabindex="0" aria-label="Descri√ß√£o do item" data-tooltip="Nome do produto como aparece no cadastro." data-tooltip-position="top">?</span></span></th>
                            <th><span class="header-label">Vendas 4M<span class="info-icon has-tooltip" tabindex="0" aria-label="Vendas nos √∫ltimos 4 meses" data-tooltip="Total vendido nos √∫ltimos 4 meses considerado nesta an√°lise." data-tooltip-position="top">?</span></span></th>
                            <th><span class="header-label">% Individual<span class="info-icon has-tooltip" tabindex="0" aria-label="Percentual individual" data-tooltip="Mostra quanto o produto representa sozinho do total vendido pelos itens com sa√≠da. Com base nele definimos as classes: 5% ou mais ‚Üí A; entre 1% e 5% ‚Üí B; abaixo de 1% ‚Üí C." data-tooltip-position="top">?</span></span></th>
                            <th><span class="header-label">Classe<span class="info-icon has-tooltip" tabindex="0" aria-label="Classe ABC" data-tooltip="Definida diretamente pelo % Individual do item: 5% ou mais das vendas ficam na Classe A, entre 1% e 5% na Classe B e o restante na Classe C." data-tooltip-position="top">?</span></span></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.join('')}
                    </tbody>
                </table>
            `;

            const footer = sortedData.length > displayLimit
                ? `<p class="pareto-empty">Exibindo top ${displayLimit} de ${sortedData.length} produtos.</p>`
                : '';

            container.innerHTML = tableHtml + footer;
            initializeTooltips(container);
        }

        function updateTable() {
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = '';

            filteredData.forEach(function(product) {
                const row = document.createElement('tr');
                const stock14Value = Number(product.stock14 || 0);
                const stock9013Value = Number(product.stock9013 || 0);
                const stock9015Value = Number(product.stock9015 || 0);
                const totalStock = stock14Value + stock9013Value + stock9015Value;
                const coverageValue = getCoverageValue(product);
                const coverageMeta = getCoverageSourceMetadata(product);
                const normalizedCoverage = Number.isFinite(product.stockMonths)
                    ? product.stockMonths
                    : (Number.isFinite(coverageValue) ? coverageValue : 0);
                const statusClass = getStatusClass(normalizedCoverage);
                const predictionInfo = getPrediction(product);
                const predictionCellContent = predictionInfo
                    ? `<span class="tooltip-underline has-tooltip prediction-tooltip" tabindex="0" aria-label="Detalhes da previs√£o" data-tooltip="${escapeTooltip(predictionInfo.detail || predictionInfo.fullText || '')}">${escapeTooltip(predictionInfo.label || '--')}</span>`
                    : '--';

                const vendas4MDisplay = (!product.vendas4M || product.vendas4M === 0) ? 'S/ VENDA' : Number(product.vendas4M).toLocaleString('pt-BR');
                const vendas4MClass = (!product.vendas4M || product.vendas4M === 0) ? 'status-warning' : '';
                const media3MDisplay = Number.isFinite(product.media3M)
                    ? Math.round(product.media3M).toLocaleString('pt-BR')
                    : '0';
                const hasCoverageData = coverageMeta.key !== 'none' && Number.isFinite(coverageValue);
                const coverageValueDisplay = hasCoverageData
                    ? `${formatStatValue(coverageValue)} meses`
                    : '--';
                const coverageSourceClass = coverageMeta.className;
                const coverageSourceLabel = coverageMeta.label;
                const coverageSourceDetail = coverageMeta.detail || '';
                const coverageSourceTitle = coverageSourceDetail
                    ? ` title="${escapeTooltip(coverageSourceDetail)}"`
                    : '';
                const codeValue = (product.code || '').toString();
                const hasCode = codeValue.trim() !== '';
                const safeCodeAttr = escapeTooltip(codeValue);
                const codeDisplay = hasCode ? escapeTooltip(codeValue) : '‚Äî';
                const codeCellContent = hasCode
                    ? `<span class="code-value">${codeDisplay}</span>`
                    : '‚Äî';
                const safeSupplier = escapeTooltip(product.supplier || '‚Äî');
                const safeFamily = escapeTooltip(product.family || '‚Äî');
                const itemText = escapeTooltip(product.item || '‚Äî');
                const itemInteractive = hasCode
                    ? `<button type="button" class="link-button" data-code="${safeCodeAttr}" onclick="openProductHistoryFromElement(this)">${itemText}</button>`
                    : itemText;
                const rawCoverageTagLabel = (coverageSourceLabel || '').trim();
                const normalizedCoverageTagLabel = rawCoverageTagLabel.toLowerCase();
                const coverageTagText = (normalizedCoverageTagLabel === 'planilha' || normalizedCoverageTagLabel === 'dados importados')
                    ? ''
                    : rawCoverageTagLabel;
                const coverageTagHtml = coverageTagText
                    ? `<span class="coverage-tag ${coverageSourceClass}"${coverageSourceTitle}>${coverageTagText}</span>`
                    : '';
                const itemCellContent = `
                    <div class="item-name">${itemInteractive}</div>
                    <div class="item-coverage">
                        Cobertura: <strong>${coverageValueDisplay}</strong>
                        ${coverageTagHtml}
                    </div>
                `.trim();

                const fallbackAbcClass = abcClassificationMap.get(product.code);
                const rawAbcClass = (typeof product.currentAbcClass === 'string' && product.currentAbcClass)
                    ? product.currentAbcClass
                    : fallbackAbcClass;
                const normalizedAbcClass = (typeof rawAbcClass === 'string' && rawAbcClass)
                    ? rawAbcClass.toUpperCase()
                    : '‚Äî';
                const isValidAbcClass = normalizedAbcClass === 'A' || normalizedAbcClass === 'B' || normalizedAbcClass === 'C';
                const abcCellContent = isValidAbcClass
                    ? `<span class="abc-chip abc-${normalizedAbcClass.toLowerCase()}">${normalizedAbcClass}</span>`
                    : '‚Äî';

                row.innerHTML = `
                    <td>${codeCellContent}</td>
                    <td>${safeSupplier}</td>
                    <td>${safeFamily}</td>
                    <td>${itemCellContent}</td>
                    <td>${stock14Value.toLocaleString('pt-BR')}</td>
                    <td>${stock9013Value.toLocaleString('pt-BR')}</td>
                    <td>${stock9015Value.toLocaleString('pt-BR')}</td>
                    <td><strong>${totalStock.toLocaleString('pt-BR')}</strong></td>
                    <td class="${vendas4MClass}">${vendas4MDisplay}</td>
                    <td>${media3MDisplay}</td>
                    <td class="status-cell prediction-cell ${statusClass}">${predictionCellContent}</td>
                    <td class="status-cell ${statusClass}">${getStatusText(normalizedCoverage)}</td>
                    <td>${abcCellContent}</td>

                `;

                if (normalizedAbcClass === 'A') {
                    row.classList.add('abc-row-a');
                } else if (normalizedAbcClass === 'B') {
                    row.classList.add('abc-row-b');
                } else if (normalizedAbcClass === 'C') {
                    row.classList.add('abc-row-c');
                }

                row.dataset.abcClass = normalizedAbcClass;

                tableBody.appendChild(row);
            });

            document.getElementById('tableCount').textContent = `${filteredData.length} produtos exibidos`;
            
            if (searchTerm) {
                highlightSearchResults();
            }

            initializeTooltips(tableBody);
        }

        function openProductHistoryFromElement(element) {
            if (!element) {
                return;
            }

            const code = element.getAttribute('data-code');
            if (code) {
                openProductHistory(code);
            }
        }

        function openProductHistory(code) {
            if (!code) {
                showMessage('‚ùå C√≥digo inv√°lido para exibir detalhes.', 'error');
                return;
            }

            const normalizedCode = code.toString().trim().toLowerCase();
            const product = allProductsData.find(function(item) {
                return (item.code || '').toString().trim().toLowerCase() === normalizedCode;
            });

            if (!product) {
                showMessage('‚ùå Produto n√£o encontrado para exibir hist√≥rico.', 'error');
                return;
            }

            const modal = document.getElementById('historyModal');
            const contentContainer = document.getElementById('historyModalContent');
            const modalTitle = document.getElementById('historyModalTitle');

            if (!modal || !contentContainer || !modalTitle) {
                showMessage('‚ùå N√£o foi poss√≠vel exibir o hist√≥rico neste momento.', 'error');
                return;
            }

            const aggregatedMonthly = (Array.isArray(product.monthlyValues) && product.monthlyValues.length > 0)
                ? sortMonthlyValues(cloneMonthlyValues(product.monthlyValues))
                : buildFallbackMonthlyValues(product);

            const historyEntries = Array.isArray(product.importHistory)
                ? product.importHistory.map(normalizeHistoryEntry)
                : [];

            const monthlyRows = aggregatedMonthly.length > 0
                ? aggregatedMonthly.map(function(entry) {
                    return `<tr><td>${escapeTooltip(entry.label || 'M√™s')}</td><td>${formatHistoryDisplayValue(entry)}</td></tr>`;
                }).join('')
                : '<tr><td colspan="2">Sem dados mensais importados.</td></tr>';

            const formatMetric = function(value, decimals) {
                const numeric = Number(value);
                if (!Number.isFinite(numeric)) {
                    return '--';
                }
                return numeric.toLocaleString('pt-BR', {
                    minimumFractionDigits: decimals || 0,
                    maximumFractionDigits: decimals || 0
                });
            };

            const coverageMeta = getCoverageSourceMetadata(product);
            const currentCoverageValue = getCoverageValue(product);
            const hasCoverageInfo = coverageMeta.key !== 'none' && Number.isFinite(currentCoverageValue);
            const coverageDisplay = hasCoverageInfo
                ? formatCoverageDisplay(currentCoverageValue)
                : { displayValue: '--', unitLabel: '', unitType: null };
            const coverageValueDisplay = coverageDisplay.displayValue;
            const coverageStatusClass = hasCoverageInfo ? getStatusClass(currentCoverageValue) : 'status-neutral';
            const coverageStatusText = hasCoverageInfo ? getStatusText(currentCoverageValue) : 'Sem dados suficientes';
            const coverageSourceParts = [coverageMeta.label, coverageMeta.detail].filter(Boolean);
            const coverageSourceDescription = coverageMeta.key === 'none'
                ? coverageMeta.detail
                : ((coverageMeta.key === 'cobertura' || coverageMeta.key === 'stockMonths')
                    ? ''
                    : (coverageSourceParts.length > 0
                        ? `Origem dos dados: ${coverageSourceParts.join(' ¬∑ ')}`
                        : ''));
            const coverageUnitHtml = hasCoverageInfo && coverageDisplay.unitLabel
                ? `<span class="history-coverage-unit">${coverageDisplay.unitLabel}</span>`
                : '';
            const coverageSourceNote = coverageSourceDescription
                ? `<p class="history-coverage-meta">${escapeTooltip(coverageSourceDescription)}</p>`
                : '';
            const coverageSectionHtml = `
                <section class="history-overview history-coverage">
                    <div class="history-coverage-info">
                        <div class="history-coverage-main">
                            <div class="history-coverage-heading">
                                <span class="history-coverage-title">Cobertura atual</span>
                                <span class="history-coverage-status ${coverageStatusClass}">${coverageStatusText}</span>
                            </div>
                            <div class="history-coverage-value-group">
                                <span class="history-coverage-value">${coverageValueDisplay}</span>
                                ${coverageUnitHtml}
                            </div>
                        </div>
                        ${coverageSourceNote}
                    </div>
                </section>
            `;

            const historySections = historyEntries.length > 0
                ? historyEntries.map(function(entry, index) {
                    const sectionTitle = entry.sheetName ? escapeTooltip(entry.sheetName) : `Registro ${index + 1}`;
                    const monthsRows = entry.months.length > 0
                        ? entry.months.map(function(monthEntry) {
                            return `<tr><td>${escapeTooltip(monthEntry.label || 'M√™s')}</td><td>${formatHistoryDisplayValue(monthEntry)}</td></tr>`;
                        }).join('')
                        : '<tr><td colspan="2">Sem valores informados.</td></tr>';
                    const totals = entry.totals || {};
                    const totalsMetricsList = [
                        { label: 'Estoque 1-4', value: totals.stock14 },
                        { label: 'Estoque 90-13', value: totals.stock9013 },
                        { label: 'Estoque 90-15', value: totals.stock9015 },
                        { label: 'Estoque Total', value: totals.totalStock },
                        { label: 'Vendas 4M', value: totals.vendas4M },
                        { label: 'M√©dia 3M', value: totals.media3M }
                    ];
                    const totalsMetrics = totalsMetricsList.map(function(metric) {
                        return `<li><span class="history-metric-label">${metric.label}</span><span class="history-metric-value">${formatMetric(metric.value, metric.decimals)}</span></li>`;
                    }).join('');
                    const coverageMetricDisplay = Number.isFinite(totals.cobertura)
                        ? formatCoverageDisplay(totals.cobertura)
                        : null;
                    const coverageMetricHtml = `<li class="history-metric-coverage"><span class="history-metric-label">Estoque em meses</span><span class="history-metric-value">${coverageMetricDisplay && coverageMetricDisplay.unitLabel ? `${coverageMetricDisplay.displayValue} ${coverageMetricDisplay.unitLabel}` : '--'}</span></li>`;
                    const entryCoverageMeta = getCoverageSourceMetadata({
                        coverageSource: entry.coverageSource,
                        stockMonths: totals.cobertura,
                        cobertura: totals.cobertura
                    });
                    const entryCoverageParts = [entryCoverageMeta.label, entryCoverageMeta.detail].filter(Boolean);
                    const entryCoverageDescription = entryCoverageMeta.key === 'none'
                        ? 'Estoque em meses n√£o informado para este per√≠odo.'
                        : ((entryCoverageMeta.key === 'cobertura' || entryCoverageMeta.key === 'stockMonths')
                            ? ''
                            : `Origem dos dados: ${entryCoverageParts.join(' ¬∑ ')}`);
                    const entryCoverageNote = entryCoverageDescription
                        ? `<p class="history-coverage-meta">${escapeTooltip(entryCoverageDescription)}</p>`
                        : '';

                    return `
                        <article class="history-entry">
                            <h4>${sectionTitle}</h4>
                            <div class="history-grid">
                                <div class="history-summary">
                                    <h5>Resumo do per√≠odo</h5>
                                    <ul class="history-metric-list">${totalsMetrics}${coverageMetricHtml}</ul>
                                    ${entryCoverageNote}
                                </div>
                                <div class="history-months">
                                    <h5>Hist√≥rico de importa√ß√µes</h5>
                                    <table class="history-month-table">
                                        <thead><tr><th>M√™s</th><th>Volume</th></tr></thead>
                                        <tbody>${monthsRows}</tbody>
                                    </table>
                                </div>
                            </div>
                        </article>
                    `;
                }).join('')
                : '<p class="empty-history">Sem hist√≥rico de importa√ß√µes salvo para este item.</p>';

            const codeDisplay = escapeTooltip(product.code || '‚Äî');
            const itemDisplay = escapeTooltip(product.item || '‚Äî');
            const supplierDisplay = escapeTooltip(product.supplier || '‚Äî');
            const familyDisplay = escapeTooltip(product.family || '‚Äî');
            const familyAccent = getFamilyAccent(product.family);
            const historyStyleAttributes = familyAccent
                ? ` style="--history-header-gradient: ${familyAccent.gradient}; --history-header-text: ${familyAccent.text}; --history-header-subtext: ${familyAccent.subText}; --history-family-chip-bg: ${familyAccent.chipBackground}; --history-family-chip-text: ${familyAccent.chipText};"`
                : '';

            const historyHtml = `
                <div class="history-modal-content"${historyStyleAttributes}>
                    <header class="history-header">
                        <div class="history-title">
                            <span class="history-code">${codeDisplay}</span>
                            <h1>${itemDisplay}</h1>
                            <p class="history-subtitle">Hist√≥rico e evolu√ß√£o dos dados importados para o produto.</p>
                        </div>
                        <div class="history-meta">
                            <span class="history-chip">Fornecedor: ${supplierDisplay}</span>
                            <span class="history-chip family-chip">Fam√≠lia: ${familyDisplay}</span>
                        </div>
                    </header>
                    ${coverageSectionHtml}
                    <section class="history-overview">
                        <h2 class="history-section-title">Pr√≥ximas importa√ß√µes</h2>
                        <table class="history-month-table">
                            <thead><tr><th>M√™s</th><th>Volume</th></tr></thead>
                            <tbody>${monthlyRows}</tbody>
                        </table>
                    </section>
                    <section class="history-overview">
                        <h2 class="history-section-title">Hist√≥rico de importa√ß√µes</h2>
                        ${historySections}
                    </section>
                </div>
            `;

            modalTitle.textContent = `Hist√≥rico do Produto ¬∑ ${codeDisplay}`;
            contentContainer.innerHTML = historyHtml;
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');

            const closeButton = modal.querySelector('.close');
            if (closeButton) {
                closeButton.focus();
            }
        }

        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (!modal) {
                return;
            }

            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');

            const contentContainer = document.getElementById('historyModalContent');
            if (contentContainer) {
                contentContainer.innerHTML = '';
            }
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('historyModal');
            if (modal && event.target === modal) {
                closeHistoryModal();
            }
        });

        window.addEventListener('keydown', function(event) {
            if (event.key !== 'Escape') {
                return;
            }

            const modal = document.getElementById('historyModal');
            if (modal && modal.style.display === 'block') {
                closeHistoryModal();
            }
        });

        function normalizeStockValue(value) {
            const numeric = Number(value);
            return Number.isFinite(numeric) ? numeric : 0;
        }

        function getProductStock(product) {
            const stock14 = normalizeStockValue(product.stock14);
            const stock9013 = normalizeStockValue(product.stock9013);
            const stock9015 = normalizeStockValue(product.stock9015);

            switch(currentEstablishment) {
                case '1-4': return stock14;
                case '90-13': return stock9013;
                case '90-15': return stock9015;
                default: return stock14 + stock9013 + stock9015;
            }
        }

        function getPrediction(product) {
            const coverage = getCoverageInfo(product);
            const { urgentDays, warningDays } = getPredictionSettings();

            if (coverage.outOfStock) {
                return {
                    label: 'S/ Estoque',
                    detail: 'Ruptura imediata ‚Äî produto sem unidades dispon√≠veis no estoque atual.',
                    fullText: 'Sem estoque ‚Äî ruptura imediata'
                };
            }

            if (!coverage.hasDemand || coverage.daysToDepletion === null) {
                return {
                    label: 'Sem demanda recente',
                    detail: 'Sem consumo registrado nos √∫ltimos meses, por isso n√£o √© poss√≠vel estimar a data de ruptura.',
                    fullText: 'Sem demanda recente ‚Äî cobertura indefinida'
                };
            }

            const hasStockMonths = Number.isFinite(product.stockMonths);
            const monthsCoverage = hasStockMonths ? product.stockMonths : (coverage.daysToDepletion / 30);
            const formattedMonths = monthsCoverage !== null ? formatStatValue(monthsCoverage) : '--';
            const daysToDepletion = Math.max(1, Math.round(hasStockMonths ? product.stockMonths * 30 : coverage.daysToDepletion));
            const estimatedDate = new Date(Date.now() + daysToDepletion * 86400000);
            const formattedDate = estimatedDate.toLocaleDateString('pt-BR');
            const monthsText = monthsCoverage !== null ? `${formattedMonths} meses` : 'cobertura indefinida';
            const baseDetail = `Ruptura estimada para ${formattedDate} (cobertura aproximada de ${monthsText}).`;

            if (daysToDepletion <= urgentDays) {
                const label = `Em ${daysToDepletion} dias`;
                const fullText = `Ruptura estimada em ${formattedDate} (aproximadamente ${daysToDepletion} dias).`;
                return {
                    label,
                    detail: `${baseDetail} Recomendado acionar reposi√ß√£o imediata.`,
                    fullText
                };
            }

            if (daysToDepletion <= warningDays) {
                const label = `Em ${daysToDepletion} dias`;
                const fullText = `Ruptura estimada em ${formattedDate} (aproximadamente ${daysToDepletion} dias).`;
                return {
                    label,
                    detail: `${baseDetail} Planeje reposi√ß√£o para evitar ruptura no curto prazo.`,
                    fullText
                };
            }

            const stableLabel = `${formattedMonths} meses`;
            const fullText = `Ruptura estimada em ${formattedDate} (cobertura aproximada de ${monthsText}).`;
            return {
                label: stableLabel,
                detail: `${baseDetail} Estoque confort√°vel considerando o ritmo de consumo atual.`,
                fullText
            };
        }

        function getStatusClass(months) {
            if (months < 2) return 'status-critical';
            if (months < 6) return 'status-warning';
            return 'status-good';
        }

        function getStatusText(months) {
            if (months < 2) return 'Cr√≠tico';
            if (months < 6) return 'Aten√ß√£o';
            return 'Bom';
        }

        // === FUN√á√ïES DE GAUGES ===
        function updateGauges() {
            const families = [...new Set(filteredData.map(function(p) {
                return p.family;
            }))].sort();
            const container = document.getElementById('gaugesContainer');
            container.innerHTML = '';

            families.forEach(function(family, index) {
                const familyProducts = getFamilyFilteredProducts(family);
                if (familyProducts.length === 0) return;
                
                const avgStock = calculateAverageStock(familyProducts);
                const criticalCount = familyProducts.filter(function(p) {
                    const hasStock = currentEstablishment ? 
                        getProductStock(p) > 0 : 
                        (p.stock14 + p.stock9013 + p.stock9015) > 0;
                    return hasStock && p.stockMonths < 2;
                }).length;

                const card = document.createElement('div');
                card.className = 'gauge-card';
                
                if (selectedFamily === family) {
                    card.classList.add('selected');
                }
                
                const shouldHighlight = searchTerm && family.toLowerCase().includes(searchTerm);
                if (shouldHighlight) {
                    card.classList.add('highlighted');
                }

                card.onclick = function() {
                    filterByGauge(family);
                };
                card.style.cursor = 'pointer';
                card.title = `Clique para filtrar produtos da fam√≠lia ${family}`;

                card.innerHTML = `
                    <div class="gauge-title">${family}</div>
                    <div class="gauge">
                        <canvas id="gauge${index}" width="240" height="140"></canvas>
                        <div class="gauge-value">${avgStock.toFixed(1)}</div>
                        <div class="gauge-label">meses</div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                        ${familyProducts.length} produtos | ${criticalCount} cr√≠ticos
                    </div>
                `;
                container.appendChild(card);

                setTimeout(function() {
                    card.classList.add('animating');
                }, index * 100);

                drawGauge(`gauge${index}`, avgStock, family, index * 200);
            });
        }

        function getFamilyFilteredProducts(family) {
            return filteredData.filter(function(product) {
                return product.family === family;
            });
        }

        function calculateAverageStock(products) {
            if (products.length === 0) return 0;
            return products.reduce(function(sum, p) {
                return sum + p.stockMonths;
            }, 0) / products.length;
        }

        function drawGauge(canvasId, value, title, delay) {
            delay = delay || 0;
            setTimeout(function() {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height - 25;
                const radius = 90;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI, 0);
                ctx.lineWidth = 20;
                ctx.strokeStyle = '#e0e0e0';
                ctx.stroke();

                let color;
                if (value < 3) {
                    color = '#f44336';
                } else if (value < 6) {
                    color = '#ff9800';
                } else {
                    color = '#4caf50';
                }

                const maxValue = 12;
                const targetAngle = Math.min(value / maxValue, 1) * Math.PI;
                let currentAngle = 0;
                const animationDuration = 1000;
                const startTime = Date.now();

                function animate() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    currentAngle = targetAngle * progress;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, Math.PI, 0);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.stroke();

                    if (currentAngle > 0) {
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, Math.PI, Math.PI + currentAngle);
                        ctx.lineWidth = 20;
                        ctx.strokeStyle = color;
                        ctx.stroke();
                    }

                    drawGaugeMarks(ctx, centerX, centerY, radius);

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                }

                animate();
            }, delay);
        }

        function drawGaugeMarks(ctx, centerX, centerY, radius) {
            for (let i = 0; i <= 12; i += 3) {
                const markAngle = Math.PI + (i / 12) * Math.PI;
                const x1 = centerX + Math.cos(markAngle) * (radius - 30);
                const y1 = centerY + Math.sin(markAngle) * (radius - 30);
                const x2 = centerX + Math.cos(markAngle) * (radius - 10);
                const y2 = centerY + Math.sin(markAngle) * (radius - 10);

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#333';
                ctx.stroke();

                if (i % 6 === 0) {
                    const textX = centerX + Math.cos(markAngle) * (radius - 45);
                    const textY = centerY + Math.sin(markAngle) * (radius - 45);
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(i.toString(), textX, textY + 5);
                }
            }
        }

        // === FUN√á√ïES DE EXPORTA√á√ÉO ===
        function showExportModal() {
            const modal = document.getElementById('exportModal');
            const currentDate = new Date().toISOString().split('T')[0];
            document.getElementById('fileName').value = `estoque_preditivo_${currentDate}`;
            modal.style.display = 'block';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function confirmExport() {
            const fileName = document.getElementById('fileName').value || 'estoque_dados';
            const fileFormat = document.getElementById('fileFormat').value;
            
            const exportData = filteredData.map(function(p) {
                const predictionInfo = getPrediction(p);
                const coverageValueExport = getCoverageValue(p);
                    return {
                        'C√ìDIGO': p.code,
                        'FORNECEDOR': p.supplier,
                        'FAM√çLIA': p.family,
                        'ITEM': p.item,
                        'ESTOQUE 1-4': p.stock14,
                        'ESTOQUE 90-13': p.stock9013,
                        'ESTOQUE 90-15': p.stock9015,
                        'TOTAL ESTOQUE': p.stock14 + p.stock9013 + p.stock9015,
                        'VENDAS 4M': (!p.vendas4M || p.vendas4M === 0) ? 'S/ VENDA' : p.vendas4M,
                        'M√âDIA 3M': p.media3M,
                        'NOVEMBRO': p.novembro,
                        'DEZEMBRO': p.dezembro,
                        'COBERTURA (PLANILHA)': Number.isFinite(coverageValueExport) ? coverageValueExport : '',
                        'ESTOQUE EM MESES': p.stockMonths,
                        'PREVIS√ÉO': predictionInfo ? (predictionInfo.fullText || predictionInfo.label) : '--',
                        'STATUS': getStatusText(p.stockMonths)
                    };
                });

            if (fileFormat === 'csv') {
                const csv = convertToCSV(exportData);
                downloadFile(csv, `${fileName}.csv`, 'text/csv');
            } else {
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Estoque');
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            }
            
            closeExportModal();
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(',')
            ].concat(data.map(function(row) {
                return headers.map(function(header) {
                    return `"${row[header]}"`;
                }).join(',');
            })).join('\n');
            return csvContent;
        }

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function updateData() {
            resetAllFilters();
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            const resultsDiv = document.getElementById('searchResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '';
            }
            searchTerm = '';
            applyAllFilters();
            loadData();
            showMessage('‚úÖ Dashboard atualizado!', 'success');
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                closeExportModal();
            }
        }

        // Carregar arquivo de dados externo
        function loadExternalDataScript() {
            debugLog('Carregando data.js externo...');
            
            const script = document.createElement('script');
            script.src = 'data.js';
            script.onerror = function() {
                debugLog('Arquivo data.js n√£o encontrado, usando localStorage ou dados vazios');
                loadData();
            };
            script.onload = function() {
                debugLog('Arquivo data.js carregado com sucesso');
                setTimeout(function() {
                    loadData();
                }, 100);
            };
            document.head.appendChild(script);
        }

        // === INICIALIZA√á√ÉO ===
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('=== INICIALIZA√á√ÉO DO DASHBOARD v1.3 ===');
            debugLog('DOM carregado, iniciando processo...');

            try {
                initializeTooltips();
                // Primeiro detectar capacidades do navegador
                detectBrowserCapabilities();
                applyPredictionLabels();

                // Depois carregar dados
                loadExternalDataScript();
                
                // Configura√ß√µes iniciais ap√≥s carregar
                setTimeout(function() {
                    updateUI();
                    
                    // Se n√£o h√° dados, abrir automaticamente a se√ß√£o de importa√ß√£o
                    if (allProductsData.length === 0) {
                        debugLog('Nenhum dado encontrado, se√ß√£o de importa√ß√£o j√° est√° aberta');
                    }
                }, 1500);
                
            } catch (error) {
                debugLog(`Erro na inicializa√ß√£o: ${error.message}`, 'error');
                // Fallback: tentar carregar dados mesmo com erro
                try {
                    loadData();
                } catch (e) {
                    debugLog(`Erro no fallback: ${e.message}`, 'error');
                    showMessage('‚ùå Erro ao inicializar dashboard. Use o diagn√≥stico para mais detalhes.', 'error');
                }
            }
        });

        // Adicionar event listeners para inputs
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                // Throttle para melhor performance
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(performGlobalSearch, 300);
                });
            }
        });

        // Detectar mudan√ßas no localStorage (para sincroniza√ß√£o entre abas)
        window.addEventListener('storage', function(e) {
            if (e.key === 'stockData') {
                debugLog('Detectada mudan√ßa nos dados do localStorage');
                loadData();
            }
        });

        // Log de informa√ß√µes do sistema ao carregar
        console.log(`
üöÄ DASHBOARD DE ESTOQUE v1.3 - PAULO ROBERTO S. S. (@PAROSOSI)
===================================================
üìÖ Data: ${new Date().toLocaleString('pt-BR')}
üåê Navegador: ${navigator.userAgent}
üîç URL: ${window.location.href}
üîë Protocolo: ${window.location.protocol}
üíª Tela: ${screen.width}x${screen.height}
üì± Viewport: ${window.innerWidth}x${window.innerHeight}
üîß Debug: Use toggleDebug() para ativar logs detalhados
üìã Mapeamento: Use toggleMappingDebug() para ver mapeamento de colunas
===================================================
        `);
    </script>
</body>
</html>
